<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>二进制安装高可用k8s集群（v1.25.0）</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="小刘Talk">
    <meta name="keywords" content="博客,个人技术博客,运维,运维开发,技术文档,学习,面试,shell,linux,python,git,github,markdown,mysql,k8s,kubernetes">
    <meta name="baidu-site-verification" content="codeva-0ulOnZ5mxo">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d57f1eed.css" as="style"><link rel="preload" href="/assets/js/app.44d32a86.js" as="script"><link rel="preload" href="/assets/js/3.5c73636d.js" as="script"><link rel="preload" href="/assets/js/2.db635a7e.js" as="script"><link rel="preload" href="/assets/js/46.2436424e.js" as="script"><link rel="prefetch" href="/assets/js/1.e72d3a41.js"><link rel="prefetch" href="/assets/js/10.470c875d.js"><link rel="prefetch" href="/assets/js/100.7694e90b.js"><link rel="prefetch" href="/assets/js/101.de773466.js"><link rel="prefetch" href="/assets/js/102.e43f5886.js"><link rel="prefetch" href="/assets/js/103.aca15b97.js"><link rel="prefetch" href="/assets/js/104.e24987b7.js"><link rel="prefetch" href="/assets/js/105.8bd03527.js"><link rel="prefetch" href="/assets/js/106.7fdba3dc.js"><link rel="prefetch" href="/assets/js/107.5fae7fa1.js"><link rel="prefetch" href="/assets/js/108.f94c3bca.js"><link rel="prefetch" href="/assets/js/109.2c9d1cb9.js"><link rel="prefetch" href="/assets/js/11.55f1c469.js"><link rel="prefetch" href="/assets/js/110.3fed7898.js"><link rel="prefetch" href="/assets/js/111.0d7db2f7.js"><link rel="prefetch" href="/assets/js/112.9b58d506.js"><link rel="prefetch" href="/assets/js/113.34d227b2.js"><link rel="prefetch" href="/assets/js/114.e9ad4589.js"><link rel="prefetch" href="/assets/js/115.44a97d6b.js"><link rel="prefetch" href="/assets/js/116.1f447402.js"><link rel="prefetch" href="/assets/js/117.cf394d3b.js"><link rel="prefetch" href="/assets/js/118.6d145301.js"><link rel="prefetch" href="/assets/js/119.699a5b7f.js"><link rel="prefetch" href="/assets/js/12.ace28f5c.js"><link rel="prefetch" href="/assets/js/13.fe678adb.js"><link rel="prefetch" href="/assets/js/14.c4c56345.js"><link rel="prefetch" href="/assets/js/15.64878322.js"><link rel="prefetch" href="/assets/js/16.8c8ec038.js"><link rel="prefetch" href="/assets/js/17.51ce6f53.js"><link rel="prefetch" href="/assets/js/18.442ae8be.js"><link rel="prefetch" href="/assets/js/19.26a7830a.js"><link rel="prefetch" href="/assets/js/20.dccf36d3.js"><link rel="prefetch" href="/assets/js/21.93b93844.js"><link rel="prefetch" href="/assets/js/22.38e4c041.js"><link rel="prefetch" href="/assets/js/23.3a0f8d61.js"><link rel="prefetch" href="/assets/js/24.413b5042.js"><link rel="prefetch" href="/assets/js/25.4a54145c.js"><link rel="prefetch" href="/assets/js/26.873467b0.js"><link rel="prefetch" href="/assets/js/27.ef81b63e.js"><link rel="prefetch" href="/assets/js/28.e2b2c0e2.js"><link rel="prefetch" href="/assets/js/29.4a63077a.js"><link rel="prefetch" href="/assets/js/30.f238d48e.js"><link rel="prefetch" href="/assets/js/31.20151c7b.js"><link rel="prefetch" href="/assets/js/32.789d4b08.js"><link rel="prefetch" href="/assets/js/33.77a02530.js"><link rel="prefetch" href="/assets/js/34.e80359b2.js"><link rel="prefetch" href="/assets/js/35.7735b97c.js"><link rel="prefetch" href="/assets/js/36.5d720e2d.js"><link rel="prefetch" href="/assets/js/37.f22b373b.js"><link rel="prefetch" href="/assets/js/38.2b1182b1.js"><link rel="prefetch" href="/assets/js/39.0bc42f00.js"><link rel="prefetch" href="/assets/js/4.4513d890.js"><link rel="prefetch" href="/assets/js/40.8e27bbe7.js"><link rel="prefetch" href="/assets/js/41.06d0a91c.js"><link rel="prefetch" href="/assets/js/42.d0918d04.js"><link rel="prefetch" href="/assets/js/43.e9cc4f5a.js"><link rel="prefetch" href="/assets/js/44.1c5d322b.js"><link rel="prefetch" href="/assets/js/45.eddf4d4f.js"><link rel="prefetch" href="/assets/js/47.5bbd7b8f.js"><link rel="prefetch" href="/assets/js/48.6666c1dd.js"><link rel="prefetch" href="/assets/js/49.ecb5c6e0.js"><link rel="prefetch" href="/assets/js/5.8eeb4257.js"><link rel="prefetch" href="/assets/js/50.cb07db14.js"><link rel="prefetch" href="/assets/js/51.1a49d9f3.js"><link rel="prefetch" href="/assets/js/52.c9b35342.js"><link rel="prefetch" href="/assets/js/53.ab8c2c92.js"><link rel="prefetch" href="/assets/js/54.d8b74f67.js"><link rel="prefetch" href="/assets/js/55.d7679bad.js"><link rel="prefetch" href="/assets/js/56.1e1cebb6.js"><link rel="prefetch" href="/assets/js/57.e552ebc4.js"><link rel="prefetch" href="/assets/js/58.c2253558.js"><link rel="prefetch" href="/assets/js/59.894648e3.js"><link rel="prefetch" href="/assets/js/6.dc744bea.js"><link rel="prefetch" href="/assets/js/60.d518c7e3.js"><link rel="prefetch" href="/assets/js/61.683e5b01.js"><link rel="prefetch" href="/assets/js/62.e77a2932.js"><link rel="prefetch" href="/assets/js/63.de13f230.js"><link rel="prefetch" href="/assets/js/64.5e811285.js"><link rel="prefetch" href="/assets/js/65.71f077b1.js"><link rel="prefetch" href="/assets/js/66.b65bc17e.js"><link rel="prefetch" href="/assets/js/67.44201295.js"><link rel="prefetch" href="/assets/js/68.52676de0.js"><link rel="prefetch" href="/assets/js/69.190d1315.js"><link rel="prefetch" href="/assets/js/70.be689ca4.js"><link rel="prefetch" href="/assets/js/71.7a47414f.js"><link rel="prefetch" href="/assets/js/72.9fe44768.js"><link rel="prefetch" href="/assets/js/73.d609fa3b.js"><link rel="prefetch" href="/assets/js/74.24541e12.js"><link rel="prefetch" href="/assets/js/75.28e53236.js"><link rel="prefetch" href="/assets/js/76.64ac0dbd.js"><link rel="prefetch" href="/assets/js/77.7f22398e.js"><link rel="prefetch" href="/assets/js/78.75145832.js"><link rel="prefetch" href="/assets/js/79.8742b244.js"><link rel="prefetch" href="/assets/js/80.7183e01e.js"><link rel="prefetch" href="/assets/js/81.459fdba1.js"><link rel="prefetch" href="/assets/js/82.c11b9a89.js"><link rel="prefetch" href="/assets/js/83.bc962d13.js"><link rel="prefetch" href="/assets/js/84.40399def.js"><link rel="prefetch" href="/assets/js/85.3123b233.js"><link rel="prefetch" href="/assets/js/86.e000b600.js"><link rel="prefetch" href="/assets/js/87.dfeb546b.js"><link rel="prefetch" href="/assets/js/88.df6d311a.js"><link rel="prefetch" href="/assets/js/89.1f7641d5.js"><link rel="prefetch" href="/assets/js/9.fc34caf5.js"><link rel="prefetch" href="/assets/js/90.9babbd7c.js"><link rel="prefetch" href="/assets/js/91.dedab5a4.js"><link rel="prefetch" href="/assets/js/92.911a772a.js"><link rel="prefetch" href="/assets/js/93.de8e895c.js"><link rel="prefetch" href="/assets/js/94.721d7399.js"><link rel="prefetch" href="/assets/js/95.055dfde2.js"><link rel="prefetch" href="/assets/js/96.f85bbcc2.js"><link rel="prefetch" href="/assets/js/97.34d5e61c.js"><link rel="prefetch" href="/assets/js/98.04aca43a.js"><link rel="prefetch" href="/assets/js/99.6e22c440.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0a7ee356.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d57f1eed.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/ops/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>监控</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ops/grafana/" class="nav-link">grafana</a></li><li class="dropdown-subitem"><a href="/ops/prometheus/" class="nav-link">prometheus</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/coreSystemCommand/" class="nav-link">《核心系统命令实战》</a></li><li class="dropdown-subitem"><a href="/note/MySQLnote/" class="nav-link">《MySQL 是怎样运行的：从根儿上理解 MySQL》</a></li><li class="dropdown-subitem"><a href="/note/ansible/" class="nav-link">《Ansible权威指南》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/56a2b5/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/d7e255/" class="nav-link">git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/program/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3281ff/" class="nav-link">python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂七杂八" class="dropdown-title"><a href="/zaqizaba/" class="link-title">杂七杂八</a> <span class="title" style="display:none;">杂七杂八</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docsDemo/" class="nav-link">文档编写规范</a></li><li class="dropdown-item"><!----> <a href="/usedcomputers/" class="nav-link">我用过的电脑</a></li><li class="dropdown-item"><!----> <a href="/buwuzhengye/" class="nav-link">喷涂相关</a></li><li class="dropdown-item"><!----> <a href="/liubing/" class="nav-link">每日一溜</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xiaoliutalk/xiaoliutalk.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://www.xiaoliutalk.cn/img/favicon.ico"> <div class="blogger-info"><h3>小刘说</h3> <span>砥砺前行</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/ops/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>监控</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ops/grafana/" class="nav-link">grafana</a></li><li class="dropdown-subitem"><a href="/ops/prometheus/" class="nav-link">prometheus</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/coreSystemCommand/" class="nav-link">《核心系统命令实战》</a></li><li class="dropdown-subitem"><a href="/note/MySQLnote/" class="nav-link">《MySQL 是怎样运行的：从根儿上理解 MySQL》</a></li><li class="dropdown-subitem"><a href="/note/ansible/" class="nav-link">《Ansible权威指南》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/56a2b5/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/d7e255/" class="nav-link">git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/program/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3281ff/" class="nav-link">python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂七杂八" class="dropdown-title"><a href="/zaqizaba/" class="link-title">杂七杂八</a> <span class="title" style="display:none;">杂七杂八</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docsDemo/" class="nav-link">文档编写规范</a></li><li class="dropdown-item"><!----> <a href="/usedcomputers/" class="nav-link">我用过的电脑</a></li><li class="dropdown-item"><!----> <a href="/buwuzhengye/" class="nav-link">喷涂相关</a></li><li class="dropdown-item"><!----> <a href="/liubing/" class="nav-link">每日一溜</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xiaoliutalk/xiaoliutalk.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>zabbix</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/4cc6e9/" aria-current="page" class="active sidebar-link">二进制安装高可用k8s集群（v1.25.0）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#k8s集群安装网段划分" class="sidebar-link">k8s集群安装网段划分</a></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#基本环境配置" class="sidebar-link">基本环境配置</a></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#基本组件安装" class="sidebar-link">基本组件安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#containerd作为runtime" class="sidebar-link">Containerd作为Runtime</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#k8s及etcd安装" class="sidebar-link">K8s及etcd安装</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#生成证书" class="sidebar-link">生成证书</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#etcd证书" class="sidebar-link">etcd证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#k8s组件证书" class="sidebar-link">k8s组件证书</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#kubernetes系统组件配置" class="sidebar-link">Kubernetes系统组件配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#etcd配置" class="sidebar-link">etcd配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#k8s-master01" class="sidebar-link">k8s-master01</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#k8s-master02" class="sidebar-link">k8s-master02</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#k8s-master03" class="sidebar-link">k8s-master03</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#创建service" class="sidebar-link">创建Service</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#高可用配置" class="sidebar-link">高可用配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#haproxy配置" class="sidebar-link">HAProxy配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#master01-keepalived" class="sidebar-link">Master01 keepalived</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#master02-keepalived" class="sidebar-link">Master02 keepalived</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#master03-keepalived" class="sidebar-link">Master03 keepalived</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#健康检查配置" class="sidebar-link">健康检查配置</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#kubernetes组件配置" class="sidebar-link">Kubernetes组件配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#apiserver" class="sidebar-link">Apiserver</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#master01-配置" class="sidebar-link">Master01 配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#master02-配置" class="sidebar-link">Master02 配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#master03-配置" class="sidebar-link">Master03 配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#启动-apiserver" class="sidebar-link">启动 Apiserver</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#controllermanager" class="sidebar-link">ControllerManager</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#scheduler" class="sidebar-link">Scheduler</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#tls-bootstrapping-配置" class="sidebar-link">TLS Bootstrapping 配置</a></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#node节点配置" class="sidebar-link">Node节点配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#复制证书" class="sidebar-link">复制证书</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#kubelet-配置" class="sidebar-link">Kubelet 配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#kube-proxy-配置" class="sidebar-link">kube-proxy 配置</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#安装calico" class="sidebar-link">安装Calico</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#安装官方推荐版本" class="sidebar-link">安装官方推荐版本</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#安装coredns" class="sidebar-link">安装CoreDNS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#安装官方推荐版本-2" class="sidebar-link">安装官方推荐版本</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#安装-metrics-server" class="sidebar-link">安装 Metrics Server</a></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#集群验证" class="sidebar-link">集群验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#pod-必须能解析-service" class="sidebar-link">Pod 必须能解析 Service</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#pod-必须能解析跨-namespace-的-service" class="sidebar-link">Pod 必须能解析跨 namespace 的 Service</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#每个节点都必须要能访问-kubernetes-的-kubernetes-svc-443和-kube-dns-的service-53" class="sidebar-link">每个节点都必须要能访问 Kubernetes 的 kubernetes svc  443和 kube-dns 的service 53</a></li><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#pod和pod之间要能通信" class="sidebar-link">Pod和Pod之间要能通信</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#同namespace能通信" class="sidebar-link">同namespace能通信</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#跨namespace能通信" class="sidebar-link">跨namespace能通信</a></li><li class="sidebar-sub-header level4"><a href="/pages/4cc6e9/#跨机器能通信" class="sidebar-link">跨机器能通信</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/4cc6e9/#安装dashboard" class="sidebar-link">安装dashboard</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/4cc6e9/#安装指定版本dashboard" class="sidebar-link">安装指定版本dashboard</a></li></ul></li></ul></li><li><a href="/pages/b73afa/" class="sidebar-link">二进制安装高可用k8s集群（v1.27.2）</a></li><li><a href="/pages/4593b8/" class="sidebar-link">kubernetes架构解析</a></li><li><a href="/pages/721478/" class="sidebar-link">kubernetes基础概念-Pod</a></li><li><a href="/pages/e33737/" class="sidebar-link">kubernetes调度基础</a></li><li><a href="/pages/d5cb3c/" class="sidebar-link">kubernetes控制器-Deployment</a></li><li><a href="/pages/82c021/" class="sidebar-link">kubernetes控制器-Service</a></li><li><a href="/pages/8e7339/" class="sidebar-link">Kubernetes（k8s） YAML文件详解</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>harbor</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mysql</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>nexus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>jenkins</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>elasticsearch</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/d8680d/" class="sidebar-link">apache2.2升级2.4</a></li><li><a href="/pages/97d233/" class="sidebar-link">heredoc（cat EOF）</a></li><li><a href="/pages/a1f982/" class="sidebar-link">Rocky linux 9 初始化</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/ops/#运维" data-v-06225672>运维</a></li><li data-v-06225672><a href="/ops/#kubernetes" data-v-06225672>kubernetes</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>小刘</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-08-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">二进制安装高可用k8s集群（v1.25.0）<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="二进制安装高可用k8s集群-v1-25-0"><a href="#二进制安装高可用k8s集群-v1-25-0" class="header-anchor">#</a> 二进制安装高可用k8s集群（v1.25.0）</h1> <p>文档参考自 <a href="https://ke.qq.com/course/2738602" target="_blank" rel="noopener noreferrer">云原生Kubernetes全栈架构师：基于世界500强的k8s实战课程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行整理而来。感谢 <a href="https://ke.qq.com/teacher/727585266" target="_blank" rel="noopener noreferrer">杜宽<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 老师的分享。</p> <h2 id="k8s集群安装网段划分"><a href="#k8s集群安装网段划分" class="header-anchor">#</a> k8s集群安装网段划分</h2> <p>集群安装时会涉及到三个网段：</p> <p><strong>宿主机网段</strong>：就是安装k8s的服务器所属网段。</p> <p><strong>Pod网段</strong>：Pod的网段，相当于容器的IP。</p> <p><strong>Service网段</strong>：k8s service网段，service用于集群容器通信。</p> <p>一般service网段会设置为 <code>10.96.0.0/12</code></p> <p>Pod网段会设置成 <code>10.244.0.0/12</code> 或者 <code>172.16.0.1/12</code></p> <p>宿主机网段可能是 <code>192.168.0.0/24</code></p> <p>需要注意的是这三个网段不能有任何交叉。</p> <p>比如如果宿主机的IP是10.105.0.x</p> <p>那么service网段就不能是10.96.0.0/12，因为10.96.0.0/12网段可用IP是：</p> <p>10.96.0.1 ~ 10.111.255.255</p> <p>所以10.105是在这个范围之内的，属于网络交叉，此时service网段需要更换，</p> <p>可以更改为192.168.0.0/16网段（注意如果service网段是192.168开头的子网掩码最好不要是12，最好为16，因为子网掩码是12他的起始IP为192.160.0.1 不是192.168.0.1）。</p> <p>同样的道理，技术别的网段也不能重复。可以通过http://tools.jb51.net/aideddesign/ip_net_calc/计算：</p> <p><img src="https://static.xiaoliutalk.cn/img/202208291524093.jpg" alt="img"></p> <p>所以一般的推荐是，直接第一个开头的就不要重复，比如你的宿主机是192开头的，那么你的service可以是10.96.0.0/12.</p> <p>如果你的宿主机是10开头的，就直接把service的网段改成192.168.0.0/16</p> <p>如果你的宿主机是172开头的，就直接把pod网段改成192.168.0.0/12</p> <p>注意搭配，均为10网段、172网段、192网段的搭配，第一个开头数字不一样就免去了网段冲突的可能性，也可以减去计算的步骤。</p> <p><strong>不要使用带中文的服务器</strong>！</p> <p>主机相关规划：</p> <table><thead><tr><th>主机名</th> <th>IP地址</th> <th>说明</th></tr></thead> <tbody><tr><td>k8s-master01 ~ 03</td> <td>192.168.7.11 ~ 13</td> <td>master节点 * 3</td></tr> <tr><td>k8s-master-lb</td> <td>192.168.7.10</td> <td>keepalived虚拟IP（VIP）</td></tr> <tr><td>k8s-node01 ~ 02</td> <td>192.168.7.14 ~ 15</td> <td>worker节点 * 2</td></tr></tbody></table> <p>参考 <a href="https://www.xiaoliutalk.cn/pages/a1f982/" target="_blank" rel="noopener noreferrer">Rocky linux 9 初始化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行初始化操作。</p> <table><thead><tr><th><strong>配置信息</strong></th> <th>备注</th></tr></thead> <tbody><tr><td>系统版本</td> <td>Rocky Linux release 9.0 (Blue Onyx)</td></tr> <tr><td>Docker版本</td> <td>20.10.17</td></tr> <tr><td>containerd版本</td> <td>1.6.8</td></tr> <tr><td>Pod网段</td> <td>172.16.0.0/12</td></tr> <tr><td>Service网段</td> <td>10.96.0.0/12</td></tr> <tr><td>宿主机网段</td> <td>192.168.7.0/24</td></tr></tbody></table> <h2 id="基本环境配置"><a href="#基本环境配置" class="header-anchor">#</a> 基本环境配置</h2> <p>所有节点配置hosts文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;&gt;</span> /etc/hosts</span>
192.168.7.11 k8s-master01
192.168.7.12 k8s-master02
192.168.7.13 k8s-master03
192.168.7.10 k8s-master-lb # 如果不是高可用集群，该IP为Master01的IP
192.168.7.14 k8s-node01
192.168.7.15 k8s-node02
EOF</span>
<span class="token function">cat</span> /etc/hosts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>安装yum源如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>必备工具安装：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">wget</span> jq psmisc <span class="token function">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点关闭<code>firewalld</code> 、<code>dnsmasq</code>、<code>selinux</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl disable <span class="token parameter variable">--now</span> firewalld
systemctl disable <span class="token parameter variable">--now</span> dnsmasq
<span class="token comment">#systemctl disable --now NetworkManager # CentOS 7 需要关闭 NetworkManager，CentOS 8 和 Centos 9 不需要</span>
setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>所有节点关闭 <code>swap</code> 分区，<code>fstab</code> 注释 <code>swap</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.swappiness</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'/^[^#]*swap/s@^@#@'</span> /etc/fstab
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所有节点同步时间，安装 <code>chrony</code>：</p> <p><code>CentOS 7</code> 中默认使用 <code>chrony</code> 作为时间服务器，也支持 <code>NTP</code> ，需要额外安装。
<code>NTP</code> 与 <code>chrony</code> 不能同时存在，只能用其中一个，并将另一个mask掉。这里推荐使用 <code>chrony</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> chrony
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动服务：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl start chronyd <span class="token comment"># 启动服务</span>
systemctl <span class="token builtin class-name">enable</span> chronyd <span class="token comment"># 设置开机自启动，在 CentOS 8 和 Centos 9 中默认就是enable的</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>节点 <code>k8s-master01</code> 设置时间同步源为阿里源：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^pool|#pool|g'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">'2aserver ntp.aliyun.com iburst'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">'s|#allow 192.168.0.0/16|allow 192.168.7.0/24|g'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-i</span> <span class="token punctuation">\</span>
    /etc/chrony.conf
systemctl restart chronyd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>其他节点设置时间同步服务器为主节点，如果网络中有时间同步服务器，设置为对应的地址或域名即可：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">'s|^pool|#pool|g'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">'2aserver 192.168.7.11 iburst'</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-i</span> <span class="token punctuation">\</span>
    /etc/chrony.conf
systemctl restart chronyd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所有节点配置limit：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-SHn</span> <span class="token number">65535</span>
<span class="token comment"># 末尾添加如下内容</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf</span>
* soft nofile 65536
* hard nofile 131072
* soft nproc 65535
* hard nproc 655350
* soft memlock unlimited
* hard memlock unlimited　
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>节点 <code>k8s-master01</code> 免密钥登录其他节点，安装过程中生成配置文件和证书均在 <code>k8s-master01</code> 上操作，集群管理也在 <code>k8s-master01</code> 上操作，阿里云或者AWS上需要单独一台 <code>kubectl</code> 服务器。密钥配置如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> ~
ssh-keygen <span class="token parameter variable">-t</span> rsa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>k8s-master01</code> 配置免密码登录其他节点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span><span class="token keyword">do</span> ssh-copy-id <span class="token parameter variable">-i</span> .ssh/id_rsa.pub <span class="token variable">$i</span><span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>k8s-master01</code> 下载安装文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root
<span class="token function">git</span> clone https://github.com/dotbalo/k8s-ha-install.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果无法clone可以使用 <a href="https://gitee.com/dukuan/k8s-ha-install.git" target="_blank" rel="noopener noreferrer">k8s-ha-install<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行克隆。</p> <p>所有节点升级系统并重启：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum update <span class="token parameter variable">-y</span> <span class="token parameter variable">--exclude</span><span class="token operator">=</span>kernel* <span class="token operator">&amp;&amp;</span> <span class="token function">reboot</span> <span class="token comment"># CentOS7 需要升级，CentOS 8 和 Centos 9 可以按需升级系统</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点安装 <code>ipvsadm</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ipvsadm ipset sysstat conntrack libseccomp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点配置 <code>ipvs</code> 模块：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
<span class="token comment"># 新建 /etc/modules-load.d/ipvs.conf 并加入以下内容</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/modules-load.d/ipvs.conf</span>
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> systemd-modules-load.service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>检查是否加载：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301637777.png" alt=""></p> <p>开启一些k8s集群中必须的内核参数，所有节点配置k8s内核：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/k8s.conf</span>
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
net.ipv4.conf.all.route_localnet = 1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF</span>
<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>所有节点配置完内核后，重启服务器，保证重启后内核依旧加载：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">shutdown</span> <span class="token parameter variable">-r</span> now
lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301639710.png" alt=""></p> <h2 id="基本组件安装"><a href="#基本组件安装" class="header-anchor">#</a> 基本组件安装</h2> <h3 id="containerd作为runtime"><a href="#containerd作为runtime" class="header-anchor">#</a> Containerd作为Runtime</h3> <p>所有节点安装 <code>docker-ce-20.10.17</code> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 先卸载掉其他无关的插件</span>
yum <span class="token parameter variable">-y</span> remove <span class="token function">podman</span> <span class="token function">docker</span> containerd
<span class="token comment"># 安装出现 Problem: problem with installed package buildah......</span>
yum <span class="token parameter variable">-y</span> erase <span class="token function">podman</span> buildah
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce-20.10.17 docker-ce-cli-20.10.17 containerd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所有节点配置 <code>Containerd</code> 所需的模块：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/containerd.conf</span>
overlay
br_netfilter
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所有节点加载模块：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>modprobe -- overlay
modprobe -- br_netfilter
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所有节点配置 <code>Containerd</code> 所需的内核：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>所有节点加载内核：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点配置 <code>Containerd</code> 的配置文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/containerd
containerd config default <span class="token operator">|</span> <span class="token function">tee</span> /etc/containerd/config.toml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所有节点将 <code>Containerd</code> 的 <code>Cgroup</code> 改为 <code>Systemd</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s|SystemdCgroup = false|SystemdCgroup = true|g'</span> /etc/containerd/config.toml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点修改 <code>sandbox_image</code> 的值：</p> <p>配置文件中有个默认的 <code>sandbox_image = &quot;k8s.gcr.io/pause:3.6&quot;</code>，因为网络原因，理论上这个镜像是无法拉取的，但是配置了阿里云仓库就可以拉取这个镜像。所以需要手动修改 <code>sandbox_image</code> 的值，确保这个镜像可以拉取。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i.bak</span> <span class="token string">'/sandbox_image / s/= &quot;[^&quot;][^&quot;]*&quot;/= &quot;registry.cn-hangzhou.aliyuncs.com\/google_containers\/pause:3.8&quot;/'</span> /etc/containerd/config.toml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点启动 <code>Containerd</code>，并配置开机自启动：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> containerd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所有节点配置 <code>crictl</code> 客户端连接的运行时位置：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/crictl.yaml</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="k8s及etcd安装"><a href="#k8s及etcd安装" class="header-anchor">#</a> K8s及etcd安装</h3> <p>版本根据 <a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener noreferrer">kubernetes/kubernetes/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 官方发布的版本去下载。</p> <p>选择对应版本，进入 <strong>CHANGELOG</strong></p> <p><img src="https://static.xiaoliutalk.cn/img/202208292246980.png" alt=""></p> <p>选择 <strong>Server Binaries</strong></p> <p><img src="https://static.xiaoliutalk.cn/img/202208292247020.png" alt=""></p> <p>根据系统版本选择安装包即可</p> <p><img src="https://static.xiaoliutalk.cn/img/202208292248642.png" alt=""></p> <p>同样的操作，<code>etcd</code> 也选择对应的版本去下载即可。<a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener noreferrer">etcd-io/etcd/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>k8s-master01</code> 下载 <code>kubernetes</code>， <code>etcd</code> 安装包：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> https://dl.k8s.io/v1.25.0/kubernetes-server-linux-amd64.tar.gz
<span class="token function">wget</span> https://github.com/etcd-io/etcd/releases/download/v3.4.20/etcd-v3.4.20-linux-amd64.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>k8s-master01</code> 解压 <code>kubernetes</code> 安装文件，<code>etcd</code> 安装文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">tar</span> <span class="token parameter variable">-xf</span> kubernetes-server-linux-amd64.tar.gz  --strip-components<span class="token operator">=</span><span class="token number">3</span> <span class="token parameter variable">-C</span> /usr/local/bin kubernetes/server/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> etcd-v3.4.20-linux-amd64.tar.gz --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-C</span> /usr/local/bin etcd-v3.4.20-linux-amd64/etcd<span class="token punctuation">{</span>,ctl<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>版本验证：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubelet <span class="token parameter variable">--version</span>
etcdctl version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>将组件发送到其他节点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">'k8s-node01 k8s-node02'</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token variable">$NODE</span><span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token function">scp</span> /usr/local/bin/etcd* <span class="token variable">$NODE</span>:/usr/local/bin/<span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$WorkNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>     <span class="token function">scp</span> /usr/local/bin/kube<span class="token punctuation">{</span>let,-proxy<span class="token punctuation">}</span> <span class="token variable">$NODE</span>:/usr/local/bin/ <span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所有节点创建 <code>/opt/cni/bin</code> 目录：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /opt/cni/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>k8s-master01</code> 切换分支到对应的版本：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> checkout manual-installation-v1.25.x
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="生成证书"><a href="#生成证书" class="header-anchor">#</a> 生成证书</h2> <p>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的！</p> <p><code>k8s-master01</code> 下载生成证书工具：</p> <p><a href="https://github.com/cloudflare/cfssl/releases/" target="_blank" rel="noopener noreferrer">cloudflare/cfssl/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 官方下载地址，选取最新版进行下载。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">wget</span> <span class="token string">&quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.2/cfssl_1.6.2_linux_amd64&quot;</span> <span class="token parameter variable">-O</span> /usr/local/bin/cfssl
<span class="token function">wget</span> <span class="token string">&quot;https://github.com/cloudflare/cfssl/releases/download/v1.6.2/cfssljson_1.6.2_linux_amd64&quot;</span> <span class="token parameter variable">-O</span> /usr/local/bin/cfssljson
<span class="token function">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="etcd证书"><a href="#etcd证书" class="header-anchor">#</a> etcd证书</h3> <p>所有 <code>Master</code> 节点创建 <code>etcd</code> 证书目录：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> /etc/etcd/ssl <span class="token parameter variable">-p</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点创建 <code>kubernetes</code> 相关目录：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>k8s-master01</code> 生成 <code>etcd</code> 证书：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/pki
<span class="token comment"># 生成etcd CA证书和CA证书的key</span>
cfssl gencert <span class="token parameter variable">-initca</span> etcd-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd-ca
cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.7.11,192.168.7.12,192.168.7.13 <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   etcd-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/etcd/ssl/etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301038006.png" alt=""></p> <p>将证书复制到其他节点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token assign-left variable">MasterNodes</span><span class="token operator">=</span><span class="token string">'k8s-master02 k8s-master03'</span>
<span class="token assign-left variable">WorkNodes</span><span class="token operator">=</span><span class="token string">'k8s-node01 k8s-node02'</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> <span class="token variable">$MasterNodes</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token string">&quot;mkdir -p /etc/etcd/ssl&quot;</span>
     <span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>
       <span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/<span class="token variable">${FILE}</span>
     <span class="token keyword">done</span>
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="k8s组件证书"><a href="#k8s组件证书" class="header-anchor">#</a> k8s组件证书</h3> <p><code>k8s-master01</code> 生成 <code>kubernetes</code> 证书：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/pki
cfssl gencert <span class="token parameter variable">-initca</span> ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/ca
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>10.96.0.</code> 是 <code>k8s service</code> 的网段，如果说需要更改 <code>k8s service</code> 网段，那就需要更改 <code>10.96.0.1</code>。</p> <p>如果不是高可用集群，<code>192.168.7.10</code> 为 <code>k8s-master01</code> 的IP，否则为 <code>keepalived</code> 虚拟IP的IP地址。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>cfssl gencert   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">10.96</span>.0.1,192.168.7.10,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.7.11,192.168.7.12,192.168.7.13   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   apiserver-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成 <code>apiserver</code> 的聚合证书。<code>Requestheader-client-xxx requestheader-allowwd-xxx:aggerator</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>cfssl gencert   <span class="token parameter variable">-initca</span> front-proxy-ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-ca 
cfssl gencert   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes   front-proxy-client-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/front-proxy-client
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>返回结果：</p> <p><img src="https://static.xiaoliutalk.cn/img/202208301039292.png" alt=""></p> <p>生成 <code>controller-manager</code> 的证书：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   manager-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/controller-manager
<span class="token comment"># 注意，如果不是高可用集群，192.168.7.10:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
<span class="token comment"># set-cluster：设置一个集群项，</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.7.10:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 设置一个环境项，一个上下文</span>
kubectl config set-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
    <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-controller-manager <span class="token punctuation">\</span>
    <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># set-credentials 设置一个用户项</span>
kubectl config set-credentials system:kube-controller-manager <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
<span class="token comment"># 使用某个环境当做默认环境</span>
kubectl config use-context system:kube-controller-manager@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/controller-manager.kubeconfig
cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   scheduler-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/scheduler
<span class="token comment"># 注意，如果不是高可用集群，192.168.7.10:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
kubectl config set-cluster kubernetes <span class="token punctuation">\</span>
     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.7.10:8443 <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
kubectl config set-credentials system:kube-scheduler <span class="token punctuation">\</span>
     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/scheduler.pem <span class="token punctuation">\</span>
     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="token punctuation">\</span>
     --embed-certs<span class="token operator">=</span>true <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
kubectl config set-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--user</span><span class="token operator">=</span>system:kube-scheduler <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
kubectl config use-context system:kube-scheduler@kubernetes <span class="token punctuation">\</span>
     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/scheduler.kubeconfig
cfssl gencert <span class="token punctuation">\</span>
   <span class="token parameter variable">-ca</span><span class="token operator">=</span>/etc/kubernetes/pki/ca.pem <span class="token punctuation">\</span>
   -ca-key<span class="token operator">=</span>/etc/kubernetes/pki/ca-key.pem <span class="token punctuation">\</span>
   <span class="token parameter variable">-config</span><span class="token operator">=</span>ca-config.json <span class="token punctuation">\</span>
   <span class="token parameter variable">-profile</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>
   admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> /etc/kubernetes/pki/admin
<span class="token comment"># 注意，如果不是高可用集群，192.168.7.10:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.7.10:8443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config set-credentials kubernetes-admin     --client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class="token operator">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config set-context kubernetes-admin@kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes-admin     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config use-context kubernetes-admin@kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/admin.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>创建 <code>ServiceAccount Key</code> --&gt; <code>secret</code> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>openssl genrsa <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.key <span class="token number">2048</span>
openssl rsa <span class="token parameter variable">-in</span> /etc/kubernetes/pki/sa.key <span class="token parameter variable">-pubout</span> <span class="token parameter variable">-out</span> /etc/kubernetes/pki/sa.pub
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>发送证书至其他节点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> /etc/kubernetes/pki <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> etcd<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token function">scp</span> /etc/kubernetes/pki/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/pki/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>
<span class="token keyword">done</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span> 
<span class="token function">scp</span> /etc/kubernetes/<span class="token variable">${FILE}</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span><span class="token punctuation">;</span>
<span class="token keyword">done</span><span class="token punctuation">;</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>查看证书文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ls</span> /etc/kubernetes/pki/
<span class="token function">ls</span> /etc/kubernetes/pki/ <span class="token operator">|</span><span class="token function">wc</span> <span class="token parameter variable">-l</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301041181.png" alt=""></p> <h2 id="kubernetes系统组件配置"><a href="#kubernetes系统组件配置" class="header-anchor">#</a> Kubernetes系统组件配置</h2> <h3 id="etcd配置"><a href="#etcd配置" class="header-anchor">#</a> etcd配置</h3> <p><code>etcd</code> 配置大致相同，注意修改每个 <code>Master</code> 节点的 <code>etcd</code> 配置的主机名和IP地址。</p> <h4 id="k8s-master01"><a href="#k8s-master01" class="header-anchor">#</a> k8s-master01</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>cat &lt;&lt;EOF <span class="token punctuation">&gt;</span> /etc/etcd/etcd.config.yml
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'k8s-master01'</span>
<span class="token key atrule">data-dir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token key atrule">wal-dir</span><span class="token punctuation">:</span> /var/lib/etcd/wal
<span class="token key atrule">snapshot-count</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">heartbeat-interval</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token key atrule">election-timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">quota-backend-bytes</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">listen-peer-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.11:2380'</span>
<span class="token key atrule">listen-client-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.11:2379,http://127.0.0.1:2379'</span>
<span class="token key atrule">max-snapshots</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">max-wals</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">cors</span><span class="token punctuation">:</span>
<span class="token key atrule">initial-advertise-peer-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.11:2380'</span>
<span class="token key atrule">advertise-client-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.11:2379'</span>
<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
<span class="token key atrule">discovery-fallback</span><span class="token punctuation">:</span> <span class="token string">'proxy'</span>
<span class="token key atrule">discovery-proxy</span><span class="token punctuation">:</span>
<span class="token key atrule">discovery-srv</span><span class="token punctuation">:</span>
<span class="token key atrule">initial-cluster</span><span class="token punctuation">:</span> <span class="token string">'k8s-master01=https://192.168.7.11:2380,k8s-master02=https://192.168.7.12:2380,k8s-master03=https://192.168.7.13:2380'</span>
<span class="token key atrule">initial-cluster-token</span><span class="token punctuation">:</span> <span class="token string">'etcd-k8s-cluster'</span>
<span class="token key atrule">initial-cluster-state</span><span class="token punctuation">:</span> <span class="token string">'new'</span>
<span class="token key atrule">strict-reconfig-check</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">enable-v2</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enable-pprof</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">proxy</span><span class="token punctuation">:</span> <span class="token string">'off'</span>
<span class="token key atrule">proxy-failure-wait</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">proxy-refresh-interval</span><span class="token punctuation">:</span> <span class="token number">30000</span>
<span class="token key atrule">proxy-dial-timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">proxy-write-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">proxy-read-timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">client-transport-security</span><span class="token punctuation">:</span>
  <span class="token key atrule">cert-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  <span class="token key atrule">key-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  <span class="token key atrule">client-cert-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">trusted-ca-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  <span class="token key atrule">auto-tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">peer-transport-security</span><span class="token punctuation">:</span>
  <span class="token key atrule">cert-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  <span class="token key atrule">key-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  <span class="token key atrule">peer-client-cert-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">trusted-ca-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  <span class="token key atrule">auto-tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">log-package-levels</span><span class="token punctuation">:</span>
<span class="token key atrule">log-outputs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token key atrule">force-new-cluster</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h4 id="k8s-master02"><a href="#k8s-master02" class="header-anchor">#</a> k8s-master02</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>cat &lt;&lt;EOF <span class="token punctuation">&gt;</span> /etc/etcd/etcd.config.yml
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'k8s-master02'</span>
<span class="token key atrule">data-dir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token key atrule">wal-dir</span><span class="token punctuation">:</span> /var/lib/etcd/wal
<span class="token key atrule">snapshot-count</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">heartbeat-interval</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token key atrule">election-timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">quota-backend-bytes</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">listen-peer-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.12:2380'</span>
<span class="token key atrule">listen-client-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.12:2379,http://127.0.0.1:2379'</span>
<span class="token key atrule">max-snapshots</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">max-wals</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">cors</span><span class="token punctuation">:</span>
<span class="token key atrule">initial-advertise-peer-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.12:2380'</span>
<span class="token key atrule">advertise-client-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.12:2379'</span>
<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
<span class="token key atrule">discovery-fallback</span><span class="token punctuation">:</span> <span class="token string">'proxy'</span>
<span class="token key atrule">discovery-proxy</span><span class="token punctuation">:</span>
<span class="token key atrule">discovery-srv</span><span class="token punctuation">:</span>
<span class="token key atrule">initial-cluster</span><span class="token punctuation">:</span> <span class="token string">'k8s-master01=https://192.168.7.11:2380,k8s-master02=https://192.168.7.12:2380,k8s-master03=https://192.168.7.13:2380'</span>
<span class="token key atrule">initial-cluster-token</span><span class="token punctuation">:</span> <span class="token string">'etcd-k8s-cluster'</span>
<span class="token key atrule">initial-cluster-state</span><span class="token punctuation">:</span> <span class="token string">'new'</span>
<span class="token key atrule">strict-reconfig-check</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">enable-v2</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enable-pprof</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">proxy</span><span class="token punctuation">:</span> <span class="token string">'off'</span>
<span class="token key atrule">proxy-failure-wait</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">proxy-refresh-interval</span><span class="token punctuation">:</span> <span class="token number">30000</span>
<span class="token key atrule">proxy-dial-timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">proxy-write-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">proxy-read-timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">client-transport-security</span><span class="token punctuation">:</span>
  <span class="token key atrule">cert-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  <span class="token key atrule">key-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  <span class="token key atrule">client-cert-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">trusted-ca-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  <span class="token key atrule">auto-tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">peer-transport-security</span><span class="token punctuation">:</span>
  <span class="token key atrule">cert-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  <span class="token key atrule">key-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  <span class="token key atrule">peer-client-cert-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">trusted-ca-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  <span class="token key atrule">auto-tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">log-package-levels</span><span class="token punctuation">:</span>
<span class="token key atrule">log-outputs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token key atrule">force-new-cluster</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h4 id="k8s-master03"><a href="#k8s-master03" class="header-anchor">#</a> k8s-master03</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>cat &lt;&lt;EOF <span class="token punctuation">&gt;</span> /etc/etcd/etcd.config.yml
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'k8s-master03'</span>
<span class="token key atrule">data-dir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token key atrule">wal-dir</span><span class="token punctuation">:</span> /var/lib/etcd/wal
<span class="token key atrule">snapshot-count</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">heartbeat-interval</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token key atrule">election-timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">quota-backend-bytes</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">listen-peer-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.13:2380'</span>
<span class="token key atrule">listen-client-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.13:2379,http://127.0.0.1:2379'</span>
<span class="token key atrule">max-snapshots</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">max-wals</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">cors</span><span class="token punctuation">:</span>
<span class="token key atrule">initial-advertise-peer-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.13:2380'</span>
<span class="token key atrule">advertise-client-urls</span><span class="token punctuation">:</span> <span class="token string">'https://192.168.7.13:2379'</span>
<span class="token key atrule">discovery</span><span class="token punctuation">:</span>
<span class="token key atrule">discovery-fallback</span><span class="token punctuation">:</span> <span class="token string">'proxy'</span>
<span class="token key atrule">discovery-proxy</span><span class="token punctuation">:</span>
<span class="token key atrule">discovery-srv</span><span class="token punctuation">:</span>
<span class="token key atrule">initial-cluster</span><span class="token punctuation">:</span> <span class="token string">'k8s-master01=https://192.168.7.11:2380,k8s-master02=https://192.168.7.12:2380,k8s-master03=https://192.168.7.13:2380'</span>
<span class="token key atrule">initial-cluster-token</span><span class="token punctuation">:</span> <span class="token string">'etcd-k8s-cluster'</span>
<span class="token key atrule">initial-cluster-state</span><span class="token punctuation">:</span> <span class="token string">'new'</span>
<span class="token key atrule">strict-reconfig-check</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">enable-v2</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enable-pprof</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">proxy</span><span class="token punctuation">:</span> <span class="token string">'off'</span>
<span class="token key atrule">proxy-failure-wait</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">proxy-refresh-interval</span><span class="token punctuation">:</span> <span class="token number">30000</span>
<span class="token key atrule">proxy-dial-timeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">proxy-write-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
<span class="token key atrule">proxy-read-timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">client-transport-security</span><span class="token punctuation">:</span>
  <span class="token key atrule">cert-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  <span class="token key atrule">key-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  <span class="token key atrule">client-cert-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">trusted-ca-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  <span class="token key atrule">auto-tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">peer-transport-security</span><span class="token punctuation">:</span>
  <span class="token key atrule">cert-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd.pem'</span>
  <span class="token key atrule">key-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span>
  <span class="token key atrule">peer-client-cert-auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">trusted-ca-file</span><span class="token punctuation">:</span> <span class="token string">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span>
  <span class="token key atrule">auto-tls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">debug</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">log-package-levels</span><span class="token punctuation">:</span>
<span class="token key atrule">log-outputs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
<span class="token key atrule">force-new-cluster</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h4 id="创建service"><a href="#创建service" class="header-anchor">#</a> 创建Service</h4> <p>所有 <code>Master</code> 节点创建 <code>etcd service</code> 并启动：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/etcd.service</span>
[Unit]
Description=Etcd Service
Documentation=https://coreos.com/etcd/docs/latest/
After=network.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
Alias=etcd3.service
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>所有 <code>Master</code> 节点创建 <code>etcd</code> 的证书目录：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> /etc/kubernetes/pki/etcd
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> etcd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看 <code>etcd</code> 状态：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span>
etcdctl <span class="token parameter variable">--endpoints</span><span class="token operator">=</span><span class="token string">&quot;192.168.7.13:2379,192.168.7.12:2379,192.168.7.11:2379&quot;</span> <span class="token parameter variable">--cacert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span class="token parameter variable">--cert</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span class="token parameter variable">--key</span><span class="token operator">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class="token operator">=</span>table
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301718175.png" alt="image-20220830171855957"></p> <h2 id="高可用配置"><a href="#高可用配置" class="header-anchor">#</a> 高可用配置</h2> <p>公有云要用公有云自带的负载均衡，比如阿里云的<code>SLB</code>，腾讯云的<code>ELB</code>，用来替代 <code>haproxy</code>和 <code>keepalived</code>，因为公有云大部分都是不支持 <code>keepalived</code> 的，另外如果用阿里云的话，<code>kubectl</code> 控制端不能放在master节点，推荐使用腾讯云，因为阿里云的 <code>slb</code> 有回环的问题，也就是 <code>slb</code> 代理的服务器不能反向访问 <code>slb</code> ，但是腾讯云修复了这个问题？</p> <p>保留态度，目前并未使用云上资源。故无法验证。</p> <p>所有 <code>Master</code> 节点安装 <code>keepalived</code> 和 <code>haproxy</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>yum <span class="token parameter variable">-y</span> <span class="token function">install</span> keepalived haproxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="haproxy配置"><a href="#haproxy配置" class="header-anchor">#</a> HAProxy配置</h3> <p>所有 <code>Master</code> 节点配置 <code>HAProxy</code> ，配置一样：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/haproxy/haproxy.cfg</span>
global
  maxconn  2000
  ulimit-n  16384
  log  127.0.0.1 local0 err
  stats timeout 30s

defaults
  log global
  mode  http
  option  httplog
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  timeout http-request 15s
  timeout http-keep-alive 15s

frontend k8s-master
  bind 0.0.0.0:8443
  bind 127.0.0.1:8443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
  server k8s-master01    192.168.7.11:6443  check
  server k8s-master02    192.168.7.12:6443  check
  server k8s-master03    192.168.7.13:6443  check
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="master01-keepalived"><a href="#master01-keepalived" class="header-anchor">#</a> Master01 keepalived</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>cat &lt;&lt;EOF &gt; /etc/keepalived/keepalived.conf
! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 5 
    weight -5
    fall 2
    rise 1
}
vrrp_instance VI_1 {
    state MASTER
    interface eth0
    mcast_src_ip 192.168.7.11
    virtual_router_id 51
    priority 101
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.7.10
    }
    track_script {
      chk_apiserver 
} }
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="master02-keepalived"><a href="#master02-keepalived" class="header-anchor">#</a> Master02 keepalived</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf</span>
! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 5 
    weight -5
    fall 2
    rise 1
 
}
vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    mcast_src_ip 192.168.7.12
    virtual_router_id 51
    priority 100
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.7.10
    }
    track_script {
      chk_apiserver 
} }
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="master03-keepalived"><a href="#master03-keepalived" class="header-anchor">#</a> Master03 keepalived</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/keepalived/keepalived.conf</span>
! Configuration File for keepalived
global_defs {
    router_id LVS_DEVEL
}
vrrp_script chk_apiserver {
    script &quot;/etc/keepalived/check_apiserver.sh&quot;
    interval 5
    weight -5
    fall 2  
    rise 1
}
vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    mcast_src_ip 192.168.7.13
    virtual_router_id 51
    priority 100
    nopreempt
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.7.10
    }
    track_script {
      chk_apiserver 
} }
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="健康检查配置"><a href="#健康检查配置" class="header-anchor">#</a> 健康检查配置</h3> <p>所有 <code>Master</code> 节点配置 健康检查 ，配置一样：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/keepalived/check_apiserver.sh</span>
#!/bin/bash
err=0
for k in <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">3</span><span class="token variable">)</span></span>
do
    check_code=<span class="token variable"><span class="token variable">$(</span>pgrep haproxy<span class="token variable">)</span></span>
    if [[ <span class="token variable">$check_code</span> == &quot;&quot; ]]; then
        err=<span class="token variable"><span class="token variable">$(</span><span class="token function">expr</span> $err + <span class="token number">1</span><span class="token variable">)</span></span>
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ <span class="token variable">$err</span> != &quot;0&quot; ]]; then
    echo &quot;systemctl stop keepalived&quot;
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EOF</span>
<span class="token function">chmod</span> +x /etc/keepalived/check_apiserver.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>所有 <code>master</code> 节点启动 <code>haproxy</code> 和 <code>keepalived</code> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> haproxy
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> keepalived
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>VIP 验证：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ping</span> <span class="token number">192.168</span>.7.10 <span class="token parameter variable">-c</span> <span class="token number">10</span>
telnet <span class="token number">192.168</span>.7.10 <span class="token number">8443</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果 <code>ping</code> 不通且 <code>telnet</code>没有出现 <code>]</code>，则认为VIP不正常，不可在继续往下执行安装步骤，需要排查 <code>keepalived</code> 的问题，比如防火墙和 <code>selinux</code> ， <code>haproxy</code> 和 <code>keepalived</code>的状态，监听端口等。</p> <h2 id="kubernetes组件配置"><a href="#kubernetes组件配置" class="header-anchor">#</a> Kubernetes组件配置</h2> <p>所有节点创建相关目录：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="apiserver"><a href="#apiserver" class="header-anchor">#</a> Apiserver</h3> <p>注意：如果不是高可用集群，  <code>192.168.7.10</code> 改为 <code>k8s-master01</code> 的地址。</p> <p>注意：本文档使用的 <strong>k8s service 网段</strong>为 <code>10.96.0.0/12</code>，该网段不能和<strong>宿主机的网段</strong>、<strong>Pod网段</strong>的重复，请按需修改。</p> <p>所有 <code>Master</code> 节点创建 <code>kube-apiserver service</code>：</p> <h4 id="master01-配置"><a href="#master01-配置" class="header-anchor">#</a> Master01 配置</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service</span>
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --logtostderr=true  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.7.11 \
      --service-cluster-ip-range=10.96.0.0/12  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.7.11:2379,https://192.168.7.12:2379,https://192.168.7.13:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
	  --feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="master02-配置"><a href="#master02-配置" class="header-anchor">#</a> Master02 配置</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service</span>
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --logtostderr=true  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.7.12 \
      --service-cluster-ip-range=10.96.0.0/12  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.7.11:2379,https://192.168.7.12:2379,https://192.168.7.13:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
	  --feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="master03-配置"><a href="#master03-配置" class="header-anchor">#</a> Master03 配置</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-apiserver.service</span>
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-apiserver \
      --v=2  \
      --logtostderr=true  \
      --allow-privileged=true  \
      --bind-address=0.0.0.0  \
      --secure-port=6443  \
      --advertise-address=192.168.7.13 \
      --service-cluster-ip-range=10.96.0.0/12  \
      --service-node-port-range=30000-32767  \
      --etcd-servers=https://192.168.7.11:2379,https://192.168.7.12:2379,https://192.168.7.13:2379 \
      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
	  --feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false \
      --authorization-mode=Node,RBAC  \
      --enable-bootstrap-token-auth=true  \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
      --requestheader-allowed-names=aggregator  \
      --requestheader-group-headers=X-Remote-Group  \
      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
      --requestheader-username-headers=X-Remote-User
      # --token-auth-file=/etc/kubernetes/token.csv

Restart=on-failure
RestartSec=10s
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h4 id="启动-apiserver"><a href="#启动-apiserver" class="header-anchor">#</a> 启动 Apiserver</h4> <p>所有 <code>Master</code> 节点开启 <code>kube-apiserver</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>检测 <code>kube-server</code> 状态：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl status kube-apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301728495.png" alt="image-20220830172853168"></p> <h3 id="controllermanager"><a href="#controllermanager" class="header-anchor">#</a> ControllerManager</h3> <p>注意本文档使用的k8s Pod网段为 <code>172.16.0.0/12</code> ，该网段不能和<strong>宿主机网段</strong>、<strong>k8s Service网段</strong>重复，请按需修改。</p> <p>所有 <code>Master</code> 节点配置 <code>kube-controller-manager service</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-controller-manager.service</span>
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \
      --v=2 \
      --logtostderr=true \
      --root-ca-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \
      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \
      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \
      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
	  --feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false \
      --leader-elect=true \
      --use-service-account-credentials=true \
      --node-monitor-grace-period=40s \
      --node-monitor-period=5s \
      --pod-eviction-timeout=2m0s \
      --controllers=*,bootstrapsigner,tokencleaner \
      --allocate-node-cidrs=true \
      --cluster-cidr=172.16.0.0/12 \
      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \
      --node-cidr-mask-size=24
      
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>所有 <code>Master</code> 节点启动 <code>kube-controller-manager</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-controller-manager
systemctl status kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301730449.png" alt="image-20220830173037279"></p> <h3 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h3> <p>所有 <code>Master</code> 节点配置 <code>kube-scheduler service</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-scheduler.service</span>
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-scheduler \
      --v=2 \
      --logtostderr=true \
      --leader-elect=true \
      --authentication-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \
      --authorization-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \
      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>所有 <code>Master</code> 节点启动 <code>kube-scheduler</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-scheduler
systemctl status kube-scheduler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301731963.png" alt="image-20220830173137856"></p> <h2 id="tls-bootstrapping-配置"><a href="#tls-bootstrapping-配置" class="header-anchor">#</a> TLS Bootstrapping 配置</h2> <p>注意：如果不是高可用集群，<code>192.168.7.10:8443</code>改为 <code>master01</code> 的地址，8443改为 <code>apiserver</code> 的端口，默认是6443。</p> <p><code>k8s-master01</code>  节点创建 <code>bootstrap</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/bootstrap
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.7.10:8443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-credentials tls-bootstrap-token-user     <span class="token parameter variable">--token</span><span class="token operator">=</span>c8ad9c.2e4d610cf3e7426e <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>tls-bootstrap-token-user     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>注意：如果要修改bootstrap.secret.yaml的token-id和token-secret，需要保证下图红圈内的字符串一致的，并且位数是一样的。还要保证上个命令的黄色字体：c8ad9c.2e4d610cf3e7426e与你修改的字符串要一致</p> <p><img src="https://static.xiaoliutalk.cn/img/202208301419806.png" alt="image-20220830141934733"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /root/.kube<span class="token punctuation">;</span> <span class="token function">cp</span> /etc/kubernetes/admin.kubeconfig /root/.kube/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查询集群状态：</p> <p>查询集群状态正常才可以继续往下，否则需要排查k8s组件是否有故障。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get cs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301733973.png" alt="image-20220830173356911"></p> <p>创建 <code>bootstrap</code> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl create <span class="token parameter variable">-f</span> bootstrap.secret.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301735242.png" alt="image-20220830173542174"></p> <h2 id="node节点配置"><a href="#node节点配置" class="header-anchor">#</a> Node节点配置</h2> <h3 id="复制证书"><a href="#复制证书" class="header-anchor">#</a> 复制证书</h3> <p><code>k8s-master01</code>  节点复制证书到 <code>node</code> 节点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /etc/kubernetes/
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>
<span class="token function">ssh</span> <span class="token variable">$NODE</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> etcd-ca.pem etcd.pem etcd-key.pem<span class="token punctuation">;</span> <span class="token keyword">do</span>
<span class="token function">scp</span> /etc/etcd/ssl/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/etcd/ssl/
<span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">FILE</span> <span class="token keyword">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class="token punctuation">;</span> <span class="token keyword">do</span>
<span class="token function">scp</span> /etc/kubernetes/<span class="token variable">$FILE</span> <span class="token variable">$NODE</span>:/etc/kubernetes/<span class="token variable">${FILE}</span>
<span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="kubelet-配置"><a href="#kubelet-配置" class="header-anchor">#</a> Kubelet 配置</h3> <p>所有节点创建相关目录：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有节点配置 <code>kubelet service</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kubelet.service</span>
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kubelet

Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>所有节点配置 <code>kubelet service</code> 的配置文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-d</span> /etc/systemd/system/kubelet.service.d <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> /etc/systemd/system/kubelet.service.d
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">'EOF'<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span>
[Service]
Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&quot;
Environment=&quot;KUBELET_SYSTEM_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock&quot;
Environment=&quot;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml&quot;
Environment=&quot;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' &quot;
ExecStart=
ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>所有节点创建 <code>kubelet</code> 的配置文件：</p> <p>注意：如果更改了k8s的service网段，需要更改 <code>kubelet-conf.yml</code>  的 <code>clusterDNS:</code> 配置，改成k8s <strong>Service网段</strong>的第十个地址，比如<code>10.96.0.10</code></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>cat &lt;&lt;EOF <span class="token punctuation">&gt;</span> /etc/kubernetes/kubelet<span class="token punctuation">-</span>conf.yml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeletConfiguration
<span class="token key atrule">address</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10250</span>
<span class="token key atrule">readOnlyPort</span><span class="token punctuation">:</span> <span class="token number">10255</span>
<span class="token key atrule">authentication</span><span class="token punctuation">:</span>
  <span class="token key atrule">anonymous</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">cacheTTL</span><span class="token punctuation">:</span> 2m0s
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">x509</span><span class="token punctuation">:</span>
    <span class="token key atrule">clientCAFile</span><span class="token punctuation">:</span> /etc/kubernetes/pki/ca.pem
<span class="token key atrule">authorization</span><span class="token punctuation">:</span>
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> Webhook
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">cacheAuthorizedTTL</span><span class="token punctuation">:</span> 5m0s
    <span class="token key atrule">cacheUnauthorizedTTL</span><span class="token punctuation">:</span> 30s
<span class="token key atrule">cgroupDriver</span><span class="token punctuation">:</span> systemd
<span class="token key atrule">cgroupsPerQOS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">clusterDNS</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> 10.96.0.10
<span class="token key atrule">clusterDomain</span><span class="token punctuation">:</span> cluster.local
<span class="token key atrule">containerLogMaxFiles</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">containerLogMaxSize</span><span class="token punctuation">:</span> 10Mi
<span class="token key atrule">contentType</span><span class="token punctuation">:</span> application/vnd.kubernetes.protobuf
<span class="token key atrule">cpuCFSQuota</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">cpuManagerPolicy</span><span class="token punctuation">:</span> none
<span class="token key atrule">cpuManagerReconcilePeriod</span><span class="token punctuation">:</span> 10s
<span class="token key atrule">enableControllerAttachDetach</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enableDebuggingHandlers</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">enforceNodeAllocatable</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> pods
<span class="token key atrule">eventBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">eventRecordQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">evictionHard</span><span class="token punctuation">:</span>
  <span class="token key atrule">imagefs.available</span><span class="token punctuation">:</span> 15%
  <span class="token key atrule">memory.available</span><span class="token punctuation">:</span> 100Mi
  <span class="token key atrule">nodefs.available</span><span class="token punctuation">:</span> 10%
  <span class="token key atrule">nodefs.inodesFree</span><span class="token punctuation">:</span> 5%
<span class="token key atrule">evictionPressureTransitionPeriod</span><span class="token punctuation">:</span> 5m0s
<span class="token key atrule">failSwapOn</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">fileCheckFrequency</span><span class="token punctuation">:</span> 20s
<span class="token key atrule">hairpinMode</span><span class="token punctuation">:</span> promiscuous<span class="token punctuation">-</span>bridge
<span class="token key atrule">healthzBindAddress</span><span class="token punctuation">:</span> 127.0.0.1
<span class="token key atrule">healthzPort</span><span class="token punctuation">:</span> <span class="token number">10248</span>
<span class="token key atrule">httpCheckFrequency</span><span class="token punctuation">:</span> 20s
<span class="token key atrule">imageGCHighThresholdPercent</span><span class="token punctuation">:</span> <span class="token number">85</span>
<span class="token key atrule">imageGCLowThresholdPercent</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token key atrule">imageMinimumGCAge</span><span class="token punctuation">:</span> 2m0s
<span class="token key atrule">iptablesDropBit</span><span class="token punctuation">:</span> <span class="token number">15</span>
<span class="token key atrule">iptablesMasqueradeBit</span><span class="token punctuation">:</span> <span class="token number">14</span>
<span class="token key atrule">kubeAPIBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">kubeAPIQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">makeIPTablesUtilChains</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">maxOpenFiles</span><span class="token punctuation">:</span> <span class="token number">1000000</span>
<span class="token key atrule">maxPods</span><span class="token punctuation">:</span> <span class="token number">110</span>
<span class="token key atrule">nodeStatusUpdateFrequency</span><span class="token punctuation">:</span> 10s
<span class="token key atrule">oomScoreAdj</span><span class="token punctuation">:</span> <span class="token number">-999</span>
<span class="token key atrule">podPidsLimit</span><span class="token punctuation">:</span> <span class="token number">-1</span>
<span class="token key atrule">registryBurst</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">registryPullQPS</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">resolvConf</span><span class="token punctuation">:</span> /etc/resolv.conf
<span class="token key atrule">rotateCertificates</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">runtimeRequestTimeout</span><span class="token punctuation">:</span> 2m0s
<span class="token key atrule">serializeImagePulls</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">staticPodPath</span><span class="token punctuation">:</span> /etc/kubernetes/manifests
<span class="token key atrule">streamingConnectionIdleTimeout</span><span class="token punctuation">:</span> 4h0m0s
<span class="token key atrule">syncFrequency</span><span class="token punctuation">:</span> 1m0s
<span class="token key atrule">volumeStatsAggPeriod</span><span class="token punctuation">:</span> 1m0s
EOF
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>所有节点启动 <code>kubelet</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此时系统日志 <code>/var/log/messages</code> 显示如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Container runtime network not ready&quot; networkReady=&quot;NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看集群状态：</p> <p>如果是<code>networkReady</code>状态异常，因为还没有安装<strong>Calico</strong>，可暂时忽略；</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get <span class="token function">node</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301802750.png" alt="image-20220830180203618"></p> <h3 id="kube-proxy-配置"><a href="#kube-proxy-配置" class="header-anchor">#</a> kube-proxy 配置</h3> <p>注意：如果不是高可用集群，<code>192.168.7.10:8443</code>改为 <code>master01</code> 的地址，8443改为 <code>apiserver</code> 的端口，默认是6443。</p> <p><code>k8s-master01</code>  节点执行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install
kubectl <span class="token parameter variable">-n</span> kube-system create serviceaccount kube-proxy
kubectl create clusterrolebinding system:kube-proxy         <span class="token parameter variable">--clusterrole</span> system:node-proxier         <span class="token parameter variable">--serviceaccount</span> kube-system:kube-proxy
<span class="token assign-left variable">SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get sa/kube-proxy <span class="token punctuation">\</span>
    <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.secrets[0].name}'</span><span class="token variable">)</span></span>
<span class="token assign-left variable">JWT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret/$SECRET <span class="token punctuation">\</span>
<span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.data.token}'</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span><span class="token variable">)</span></span>
<span class="token assign-left variable">PKI_DIR</span><span class="token operator">=</span>/etc/kubernetes/pki
<span class="token assign-left variable">K8S_DIR</span><span class="token operator">=</span>/etc/kubernetes
kubectl config set-cluster kubernetes     --certificate-authority<span class="token operator">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="token operator">=</span>true     <span class="token parameter variable">--server</span><span class="token operator">=</span>https://192.168.7.10:8443     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span><span class="token variable">${K8S_DIR}</span>/kube-proxy.kubeconfig
kubectl config set-credentials kubernetes     <span class="token parameter variable">--token</span><span class="token operator">=</span><span class="token variable">${JWT_TOKEN}</span>     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
kubectl config set-context kubernetes     <span class="token parameter variable">--cluster</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--user</span><span class="token operator">=</span>kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
kubectl config use-context kubernetes     <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>k8s-master01</code>  节点执行，将 <code>kubeconfig</code> 发送至其他节点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-master02 k8s-master03<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig  <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
 <span class="token keyword">done</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">NODE</span> <span class="token keyword">in</span> k8s-node01 k8s-node02<span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class="token variable">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
 <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>所有节点添加 <code>kube-proxy</code> 的配置和 <code>service</code> 文件：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /usr/lib/systemd/system/kube-proxy.service</span>
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes
After=network.target

[Service]
ExecStart=/usr/local/bin/kube-proxy \
  --config=/etc/kubernetes/kube-proxy.yaml \
  --v=2

Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>如果更改了集群<strong>Pod网段</strong>，需要更改 <code>kube-proxy.yaml</code> 的 <code>clusterCIDR</code> 为自己的<strong>Pod网段</strong>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/kubernetes/kube-proxy.yaml</span>
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
clientConnection:
  acceptContentTypes: &quot;&quot;
  burst: 10
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
  qps: 5
clusterCIDR: 172.16.0.0/12 
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: 32768
  min: 131072
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: false
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: &quot;&quot;
iptables:
  masqueradeAll: false
  masqueradeBit: 14
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: true
  minSyncPeriod: 5s
  scheduler: &quot;rr&quot;
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: &quot;ipvs&quot;
nodePortAddresses: null
oomScoreAdj: -999
portRange: &quot;&quot;
udpIdleTimeout: 250ms
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>所有节点启动 <code>kube-proxy</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kube-proxy
systemctl status kube-proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="安装calico"><a href="#安装calico" class="header-anchor">#</a> 安装Calico</h2> <h3 id="安装官方推荐版本"><a href="#安装官方推荐版本" class="header-anchor">#</a> 安装官方推荐版本</h3> <p><code>k8s-master01</code>  节点执行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/calico/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>更改 <code>calico</code> 的网段，主要需要将红色部分的网段，改为自己的<strong>Pod网段</strong>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s|POD_CIDR|172.16.0.0/12|g&quot;</span> calico.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>检查网段是是否已经更改为自己的<strong>Pod网段</strong>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">grep</span> <span class="token string">&quot;IPV4POOL_CIDR&quot;</span> calico.yaml  <span class="token parameter variable">-A</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装<code>calico</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> calico.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时再次验证节点，发现都已经正常了：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get <span class="token function">node</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301825761.png" alt="image-20220830182517500"></p> <p>查看容器状态：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get po <span class="token parameter variable">-n</span> kube-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202208301838925.png" alt="image-20220830183822760"></p> <p>如果容器状态异常可以使用 <code>kubectl describe</code> 或者 <code>kubectl logs</code> 查看容器的日志。</p> <h2 id="安装coredns"><a href="#安装coredns" class="header-anchor">#</a> 安装CoreDNS</h2> <h3 id="安装官方推荐版本-2"><a href="#安装官方推荐版本-2" class="header-anchor">#</a> 安装官方推荐版本</h3> <p><code>k8s-master01</code>  节点执行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/
<span class="token comment"># 如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</span>
<span class="token assign-left variable">COREDNS_SERVICE_IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>kubectl get svc <span class="token operator">|</span> <span class="token function">grep</span> kubernetes <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span><span class="token variable">`</span></span><span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&quot;s#KUBEDNS_SERVICE_IP#<span class="token variable">${COREDNS_SERVICE_IP}</span>#g&quot;</span> CoreDNS/coredns.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>安装 <code>coredns</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl create <span class="token parameter variable">-f</span> CoreDNS/coredns.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看容器状态：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get po <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-l</span> k8s-app<span class="token operator">=</span>kube-dns
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011305334.png" alt="image-20220901130514984"></p> <h2 id="安装-metrics-server"><a href="#安装-metrics-server" class="header-anchor">#</a> 安装 Metrics Server</h2> <p>在新版的 <code>Kubernetes</code> 中系统资源的采集均使用 <code>Metrics-server</code> ，可以通过 <code>Metrics</code> 采集节点和Pod的内存、磁盘、CPU和网络的使用率。</p> <p><code>k8s-master01</code>  节点执行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/metrics-server
kubectl  create <span class="token parameter variable">-f</span> <span class="token builtin class-name">.</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>等待 <code>metrics server</code> 启动然后查看状态 ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl <span class="token function">top</span> <span class="token function">node</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011307711.png" alt="image-20220901130727641"></p> <h2 id="集群验证"><a href="#集群验证" class="header-anchor">#</a> 集群验证</h2> <p>安装 <code>busybox</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>cat<span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: busybox:1.28
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="pod-必须能解析-service"><a href="#pod-必须能解析-service" class="header-anchor">#</a> <code>Pod</code> 必须能解析 <code>Service</code></h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">exec</span>  busybox <span class="token parameter variable">-n</span> default -- <span class="token function">nslookup</span> kubernetes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011318448.png" alt="image-20220901131817361"></p> <h3 id="pod-必须能解析跨-namespace-的-service"><a href="#pod-必须能解析跨-namespace-的-service" class="header-anchor">#</a> <code>Pod</code> 必须能解析跨 <code>namespace</code> 的 <code>Service</code></h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">exec</span>  busybox <span class="token parameter variable">-n</span> default -- <span class="token function">nslookup</span> kube-dns.kube-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011319534.png" alt="image-20220901131922485"></p> <h3 id="每个节点都必须要能访问-kubernetes-的-kubernetes-svc-443和-kube-dns-的service-53"><a href="#每个节点都必须要能访问-kubernetes-的-kubernetes-svc-443和-kube-dns-的service-53" class="header-anchor">#</a> 每个节点都必须要能访问 <code>Kubernetes</code> 的 <code>kubernetes svc</code>  443和 <code>kube-dns</code> 的service 53</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get svc <span class="token comment"># CLUSTER-IP 为Kubernetes service地址</span>
kubectl get svc <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> kube-dns <span class="token comment"># CLUSTER-IP 为 kube-dns service地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所有节点执行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>telnet <span class="token number">10.96</span>.0.1 <span class="token number">443</span>
telnet <span class="token number">10.96</span>.0.10 <span class="token number">53</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>端口通则表示无问题。</p> <h3 id="pod和pod之间要能通信"><a href="#pod和pod之间要能通信" class="header-anchor">#</a> Pod和Pod之间要能通信</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get pod <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-owide</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011347007.png" alt="image-20220901134736933"></p> <h4 id="同namespace能通信"><a href="#同namespace能通信" class="header-anchor">#</a> 同namespace能通信</h4> <p>选取同 <code>namespace</code> 的两个容器，进入执行 <code>ping</code> 命令看是否能通。</p> <h4 id="跨namespace能通信"><a href="#跨namespace能通信" class="header-anchor">#</a> 跨namespace能通信</h4> <p>选取不同 <code>namespace</code> 的两个容器，进入执行 <code>ping</code> 命令看是否能通：这里以刚才安装的 <code>busybox</code> 为例：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get pod <span class="token parameter variable">-owide</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011347772.png" alt="image-20220901134758727"></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> busybox -- <span class="token function">sh</span> <span class="token comment"># 进入容器执行sh</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>选取一个其他 <code>namespace</code> 的 <code>ip</code> 进行测试：</p> <p><img src="https://static.xiaoliutalk.cn/img/202209011350922.png" alt="image-20220901135000867"></p> <h4 id="跨机器能通信"><a href="#跨机器能通信" class="header-anchor">#</a> 跨机器能通信</h4> <p>选取一个其他节点的 <code>ip</code> 进行测试：</p> <p><img src="https://static.xiaoliutalk.cn/img/202209011345316.png" alt="image-20220901134514250"></p> <p>到此集群基本上验证完毕。</p> <h2 id="安装dashboard"><a href="#安装dashboard" class="header-anchor">#</a> 安装dashboard</h2> <h3 id="安装指定版本dashboard"><a href="#安装指定版本dashboard" class="header-anchor">#</a> 安装指定版本dashboard</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /root/k8s-ha-install/dashboard/
kubectl  create <span class="token parameter variable">-f</span> <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看端口：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get svc kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011640845.png" alt="image-20220901164043581"></p> <p>根据自己的实例端口号，通过任意安装了 <code>kube-proxy</code> 的宿主机的IP+端口即可访问到 <code>dashboard</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl get svc kubernetes-dashboard <span class="token parameter variable">-n</span> kubernetes-dashboard
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202209011819821.png" alt="image-20220901181952701"></p> <p>访问Dashboard：https://192.168.7.10:31903，选择登录方式为 <code>token</code> ：</p> <p><img src="https://static.xiaoliutalk.cn/img/202209011821418.png" alt="image-20220901182104211"></p> <p><code>k8s-master01</code>  节点获取 <code>dashboard token</code> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>kubectl <span class="token parameter variable">-n</span> kube-system describe <span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> kube-system get secret <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-o</span> name <span class="token operator">|</span> <span class="token function">grep</span> namespace<span class="token variable">)</span></span> <span class="token operator">|</span> <span class="token function">grep</span> token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/11, 11:55:33</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/7d82f0/" class="prev">docker常用命令</a></span> <span class="next"><a href="/pages/b73afa/">二进制安装高可用k8s集群（v1.27.2）</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/82c021/"><div>
            kubernetes控制器-Service
            <!----></div></a> <span class="date">08-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d5cb3c/"><div>
            kubernetes控制器-Deployment
            <!----></div></a> <span class="date">08-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/e33737/"><div>
            kubernetes调度基础
            <!----></div></a> <span class="date">07-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:248920070@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xiaoliutalk" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/xiaoliuTalk" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span><a href="https://ipw.cn/ipv6webcheck/?site=www.xiaoliutalk.cn" title="本站支持IPv6访问" target="_blank"><img style="display:inline-block;vertical-align:middle" alt="本站支持IPv6访问" src="https://static.ipw.cn/icon/ipv6-s3.svg"></a>         <a href="https://ipw.cn/ssl/?site=www.xiaoliutalk.cn" title="本站支持SSL安全访问" target="_blank"><img style="display:inline-block;vertical-align:middle" alt="本站支持SSL安全访问" src="https://static.ipw.cn/icon/ssl-s3.svg"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;left:10px;bottom:0px;width:135px;height:200px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="200" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:200px;"></canvas></div><div></div></div></div>
    <script src="/assets/js/app.44d32a86.js" defer></script><script src="/assets/js/3.5c73636d.js" defer></script><script src="/assets/js/2.db635a7e.js" defer></script><script src="/assets/js/46.2436424e.js" defer></script>
  </body>
</html>
