<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Playbook基础入门</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="小刘Talk">
    <meta name="keywords" content="博客,个人技术博客,运维,运维开发,技术文档,学习,面试,shell,linux,python,git,github,markdown,mysql,k8s,kubernetes">
    <meta name="baidu-site-verification" content="codeva-0ulOnZ5mxo">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d57f1eed.css" as="style"><link rel="preload" href="/assets/js/app.44d32a86.js" as="script"><link rel="preload" href="/assets/js/3.5c73636d.js" as="script"><link rel="preload" href="/assets/js/2.db635a7e.js" as="script"><link rel="preload" href="/assets/js/104.e24987b7.js" as="script"><link rel="prefetch" href="/assets/js/1.e72d3a41.js"><link rel="prefetch" href="/assets/js/10.470c875d.js"><link rel="prefetch" href="/assets/js/100.7694e90b.js"><link rel="prefetch" href="/assets/js/101.de773466.js"><link rel="prefetch" href="/assets/js/102.e43f5886.js"><link rel="prefetch" href="/assets/js/103.aca15b97.js"><link rel="prefetch" href="/assets/js/105.8bd03527.js"><link rel="prefetch" href="/assets/js/106.7fdba3dc.js"><link rel="prefetch" href="/assets/js/107.5fae7fa1.js"><link rel="prefetch" href="/assets/js/108.f94c3bca.js"><link rel="prefetch" href="/assets/js/109.2c9d1cb9.js"><link rel="prefetch" href="/assets/js/11.55f1c469.js"><link rel="prefetch" href="/assets/js/110.3fed7898.js"><link rel="prefetch" href="/assets/js/111.0d7db2f7.js"><link rel="prefetch" href="/assets/js/112.9b58d506.js"><link rel="prefetch" href="/assets/js/113.34d227b2.js"><link rel="prefetch" href="/assets/js/114.e9ad4589.js"><link rel="prefetch" href="/assets/js/115.44a97d6b.js"><link rel="prefetch" href="/assets/js/116.1f447402.js"><link rel="prefetch" href="/assets/js/117.cf394d3b.js"><link rel="prefetch" href="/assets/js/118.6d145301.js"><link rel="prefetch" href="/assets/js/119.699a5b7f.js"><link rel="prefetch" href="/assets/js/12.ace28f5c.js"><link rel="prefetch" href="/assets/js/13.fe678adb.js"><link rel="prefetch" href="/assets/js/14.c4c56345.js"><link rel="prefetch" href="/assets/js/15.64878322.js"><link rel="prefetch" href="/assets/js/16.8c8ec038.js"><link rel="prefetch" href="/assets/js/17.51ce6f53.js"><link rel="prefetch" href="/assets/js/18.442ae8be.js"><link rel="prefetch" href="/assets/js/19.26a7830a.js"><link rel="prefetch" href="/assets/js/20.dccf36d3.js"><link rel="prefetch" href="/assets/js/21.93b93844.js"><link rel="prefetch" href="/assets/js/22.38e4c041.js"><link rel="prefetch" href="/assets/js/23.3a0f8d61.js"><link rel="prefetch" href="/assets/js/24.413b5042.js"><link rel="prefetch" href="/assets/js/25.4a54145c.js"><link rel="prefetch" href="/assets/js/26.873467b0.js"><link rel="prefetch" href="/assets/js/27.ef81b63e.js"><link rel="prefetch" href="/assets/js/28.e2b2c0e2.js"><link rel="prefetch" href="/assets/js/29.4a63077a.js"><link rel="prefetch" href="/assets/js/30.f238d48e.js"><link rel="prefetch" href="/assets/js/31.20151c7b.js"><link rel="prefetch" href="/assets/js/32.789d4b08.js"><link rel="prefetch" href="/assets/js/33.77a02530.js"><link rel="prefetch" href="/assets/js/34.e80359b2.js"><link rel="prefetch" href="/assets/js/35.7735b97c.js"><link rel="prefetch" href="/assets/js/36.5d720e2d.js"><link rel="prefetch" href="/assets/js/37.f22b373b.js"><link rel="prefetch" href="/assets/js/38.2b1182b1.js"><link rel="prefetch" href="/assets/js/39.0bc42f00.js"><link rel="prefetch" href="/assets/js/4.4513d890.js"><link rel="prefetch" href="/assets/js/40.8e27bbe7.js"><link rel="prefetch" href="/assets/js/41.06d0a91c.js"><link rel="prefetch" href="/assets/js/42.d0918d04.js"><link rel="prefetch" href="/assets/js/43.e9cc4f5a.js"><link rel="prefetch" href="/assets/js/44.1c5d322b.js"><link rel="prefetch" href="/assets/js/45.eddf4d4f.js"><link rel="prefetch" href="/assets/js/46.2436424e.js"><link rel="prefetch" href="/assets/js/47.5bbd7b8f.js"><link rel="prefetch" href="/assets/js/48.6666c1dd.js"><link rel="prefetch" href="/assets/js/49.ecb5c6e0.js"><link rel="prefetch" href="/assets/js/5.8eeb4257.js"><link rel="prefetch" href="/assets/js/50.cb07db14.js"><link rel="prefetch" href="/assets/js/51.1a49d9f3.js"><link rel="prefetch" href="/assets/js/52.c9b35342.js"><link rel="prefetch" href="/assets/js/53.ab8c2c92.js"><link rel="prefetch" href="/assets/js/54.d8b74f67.js"><link rel="prefetch" href="/assets/js/55.d7679bad.js"><link rel="prefetch" href="/assets/js/56.1e1cebb6.js"><link rel="prefetch" href="/assets/js/57.e552ebc4.js"><link rel="prefetch" href="/assets/js/58.c2253558.js"><link rel="prefetch" href="/assets/js/59.894648e3.js"><link rel="prefetch" href="/assets/js/6.dc744bea.js"><link rel="prefetch" href="/assets/js/60.d518c7e3.js"><link rel="prefetch" href="/assets/js/61.683e5b01.js"><link rel="prefetch" href="/assets/js/62.e77a2932.js"><link rel="prefetch" href="/assets/js/63.de13f230.js"><link rel="prefetch" href="/assets/js/64.5e811285.js"><link rel="prefetch" href="/assets/js/65.71f077b1.js"><link rel="prefetch" href="/assets/js/66.b65bc17e.js"><link rel="prefetch" href="/assets/js/67.44201295.js"><link rel="prefetch" href="/assets/js/68.52676de0.js"><link rel="prefetch" href="/assets/js/69.190d1315.js"><link rel="prefetch" href="/assets/js/70.be689ca4.js"><link rel="prefetch" href="/assets/js/71.7a47414f.js"><link rel="prefetch" href="/assets/js/72.9fe44768.js"><link rel="prefetch" href="/assets/js/73.d609fa3b.js"><link rel="prefetch" href="/assets/js/74.24541e12.js"><link rel="prefetch" href="/assets/js/75.28e53236.js"><link rel="prefetch" href="/assets/js/76.64ac0dbd.js"><link rel="prefetch" href="/assets/js/77.7f22398e.js"><link rel="prefetch" href="/assets/js/78.75145832.js"><link rel="prefetch" href="/assets/js/79.8742b244.js"><link rel="prefetch" href="/assets/js/80.7183e01e.js"><link rel="prefetch" href="/assets/js/81.459fdba1.js"><link rel="prefetch" href="/assets/js/82.c11b9a89.js"><link rel="prefetch" href="/assets/js/83.bc962d13.js"><link rel="prefetch" href="/assets/js/84.40399def.js"><link rel="prefetch" href="/assets/js/85.3123b233.js"><link rel="prefetch" href="/assets/js/86.e000b600.js"><link rel="prefetch" href="/assets/js/87.dfeb546b.js"><link rel="prefetch" href="/assets/js/88.df6d311a.js"><link rel="prefetch" href="/assets/js/89.1f7641d5.js"><link rel="prefetch" href="/assets/js/9.fc34caf5.js"><link rel="prefetch" href="/assets/js/90.9babbd7c.js"><link rel="prefetch" href="/assets/js/91.dedab5a4.js"><link rel="prefetch" href="/assets/js/92.911a772a.js"><link rel="prefetch" href="/assets/js/93.de8e895c.js"><link rel="prefetch" href="/assets/js/94.721d7399.js"><link rel="prefetch" href="/assets/js/95.055dfde2.js"><link rel="prefetch" href="/assets/js/96.f85bbcc2.js"><link rel="prefetch" href="/assets/js/97.34d5e61c.js"><link rel="prefetch" href="/assets/js/98.04aca43a.js"><link rel="prefetch" href="/assets/js/99.6e22c440.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0a7ee356.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d57f1eed.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/ops/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>监控</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ops/grafana/" class="nav-link">grafana</a></li><li class="dropdown-subitem"><a href="/ops/prometheus/" class="nav-link">prometheus</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/coreSystemCommand/" class="nav-link">《核心系统命令实战》</a></li><li class="dropdown-subitem"><a href="/note/MySQLnote/" class="nav-link">《MySQL 是怎样运行的：从根儿上理解 MySQL》</a></li><li class="dropdown-subitem"><a href="/note/ansible/" class="nav-link">《Ansible权威指南》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/56a2b5/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/d7e255/" class="nav-link">git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/program/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3281ff/" class="nav-link">python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂七杂八" class="dropdown-title"><a href="/zaqizaba/" class="link-title">杂七杂八</a> <span class="title" style="display:none;">杂七杂八</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docsDemo/" class="nav-link">文档编写规范</a></li><li class="dropdown-item"><!----> <a href="/usedcomputers/" class="nav-link">我用过的电脑</a></li><li class="dropdown-item"><!----> <a href="/buwuzhengye/" class="nav-link">喷涂相关</a></li><li class="dropdown-item"><!----> <a href="/liubing/" class="nav-link">每日一溜</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xiaoliutalk/xiaoliutalk.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://www.xiaoliutalk.cn/img/favicon.ico"> <div class="blogger-info"><h3>小刘说</h3> <span>砥砺前行</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/ops/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>监控</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ops/grafana/" class="nav-link">grafana</a></li><li class="dropdown-subitem"><a href="/ops/prometheus/" class="nav-link">prometheus</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/coreSystemCommand/" class="nav-link">《核心系统命令实战》</a></li><li class="dropdown-subitem"><a href="/note/MySQLnote/" class="nav-link">《MySQL 是怎样运行的：从根儿上理解 MySQL》</a></li><li class="dropdown-subitem"><a href="/note/ansible/" class="nav-link">《Ansible权威指南》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><a href="/topic/" class="link-title">专题</a> <span class="title" style="display:none;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/56a2b5/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/d7e255/" class="nav-link">git</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程" class="dropdown-title"><a href="/program/" class="link-title">编程</a> <span class="title" style="display:none;">编程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3281ff/" class="nav-link">python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂七杂八" class="dropdown-title"><a href="/zaqizaba/" class="link-title">杂七杂八</a> <span class="title" style="display:none;">杂七杂八</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docsDemo/" class="nav-link">文档编写规范</a></li><li class="dropdown-item"><!----> <a href="/usedcomputers/" class="nav-link">我用过的电脑</a></li><li class="dropdown-item"><!----> <a href="/buwuzhengye/" class="nav-link">喷涂相关</a></li><li class="dropdown-item"><!----> <a href="/liubing/" class="nav-link">每日一溜</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xiaoliutalk/xiaoliutalk.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/5d1c70/" class="sidebar-link">ansible简介&amp;安装</a></li><li><a href="/pages/8c53b7/" class="sidebar-link">ansible基础入门</a></li><li><a href="/pages/d6ca03/" class="sidebar-link">ansible的Ad-Hoc</a></li><li><a href="/pages/000a4f/" aria-current="page" class="active sidebar-link">Playbook基础入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/000a4f/#_1-playbook语法简介" class="sidebar-link">1. Playbook语法简介</a></li><li class="sidebar-sub-header level2"><a href="/pages/000a4f/#_2-playbook组件" class="sidebar-link">2. Playbook组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-1-handlers" class="sidebar-link">2.1. handlers</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-2-环境变量" class="sidebar-link">2.2. 环境变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-2-1-自定义环境变量" class="sidebar-link">2.2.1. 自定义环境变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-2-2-预定义环境变量-未完成" class="sidebar-link">2.2.2. 预定义环境变量（未完成）</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-3-变量" class="sidebar-link">2.3. 变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-1-playbook变量" class="sidebar-link">2.3.1. Playbook变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-2-inventory定义变量" class="sidebar-link">2.3.2. Inventory定义变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-3-注册变量" class="sidebar-link">2.3.3. 注册变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-4-高阶变量" class="sidebar-link">2.3.4. 高阶变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-5-主机变量和组变量" class="sidebar-link">2.3.5. 主机变量和组变量</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-6-facts-收集系统信息" class="sidebar-link">2.3.6. Facts（收集系统信息）</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-7-加密模块vault" class="sidebar-link">2.3.7. 加密模块Vault</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-3-8-变量优先级" class="sidebar-link">2.3.8. 变量优先级</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-4-流程控制" class="sidebar-link">2.4. 流程控制</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-4-1-条件判断-when" class="sidebar-link">2.4.1. 条件判断-when</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-4-2-条件判断-changed-when-failed-when" class="sidebar-link">2.4.2. 条件判断-changedwhen，failedwhen</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-4-3-条件判断-ignore-errors" class="sidebar-link">2.4.3. 条件判断-ignore_errors</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-4-4-block块" class="sidebar-link">2.4.4. Block块</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-5-循环" class="sidebar-link">2.5. 循环</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-1-with-items-with-flattened" class="sidebar-link">2.5.1. withitems，withflattened</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-2-with-list" class="sidebar-link">2.5.2. with_list</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-3-with-together" class="sidebar-link">2.5.3. with_together</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-4-with-cartesian" class="sidebar-link">2.5.4. with_cartesian</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-5-with-sequence" class="sidebar-link">2.5.5. with_sequence</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-6-with-dict" class="sidebar-link">2.5.6. with_dict</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-7-with-subelements-未完成" class="sidebar-link">2.5.7. with_subelements（未完成）</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-8-with-file" class="sidebar-link">2.5.8. with_file</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-5-9-with-fileglob" class="sidebar-link">2.5.9. with_fileglob</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-6-任务间流程控制" class="sidebar-link">2.6. 任务间流程控制</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-6-1-任务委托" class="sidebar-link">2.6.1. 任务委托</a></li><li class="sidebar-sub-header level4"><a href="/pages/000a4f/#_2-6-2-任务暂停" class="sidebar-link">2.6.2. 任务暂停</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-7-交互式提示" class="sidebar-link">2.7. 交互式提示</a></li><li class="sidebar-sub-header level3"><a href="/pages/000a4f/#_2-8-tags" class="sidebar-link">2.8. Tags</a></li></ul></li></ul></li><li><a href="/pages/7ba1c1/" class="sidebar-link">ansible进阶技巧</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/ansible/#《Ansible权威指南》" data-v-06225672>《Ansible权威指南》</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>小刘</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-02-16</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Playbook基础入门<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="playbook基础入门"><a href="#playbook基础入门" class="header-anchor">#</a> Playbook基础入门</h1> <h2 id="_1-playbook语法简介"><a href="#_1-playbook语法简介" class="header-anchor">#</a> 1. Playbook语法简介</h2> <p>Playbook采用YAML语法编写，参考<a href="https://www.runoob.com/w3cnote/yaml-intro.html" target="_blank" rel="noopener noreferrer">YAML 入门教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>进行学习，这里不再赘述。</p> <p>了解了普通的YAML格式文件，我们来看一下正式的Playbook内容是什么样的：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment">#这个是你选择的主机</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token comment">#这个是变量</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">http_port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">max_clients</span><span class="token punctuation">:</span> <span class="token number">200</span>
    <span class="token comment">#远端的执行权限</span>
    <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install Apache
     <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">{</span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token punctuation">}</span> state=present
     <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> httpd
         <span class="token punctuation">-</span> httpd<span class="token punctuation">-</span>devel
    <span class="token comment"># 确认已安装apache</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure that apache is installed
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> 
        <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
    <span class="token comment">#利用yum模块来操作</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is at the latest version
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> pkg=httpd state=latest
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> write the apache config file
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=/srv/httpd.j2 dest=/etc/httpd/conf/httpd.conf
      <span class="token comment">#触发重启服务器</span>
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart apache
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is running
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started
  <span class="token comment">#这里的restart apache 和上面的触发是配对的。这就是handlers的作用。相当于tag</span>
  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart apache
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><ol><li>需要以“---”（3个减号）开始，且需顶行首写。</li> <li>次行开始正常写Playbook的内容。可以指定此Playbook的用途。</li> <li>缩进必须是统一的，不能将空格和Tab混用。</li> <li>缩进的级别必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结合换行来实现的。</li> <li>YAML文件内容和Linux系统大小写判断方式保持一致，是区别大小写的，k/v的值均需大小写敏感。</li> <li><code>key/value</code>的值可同行写也可换行写。同行使用“：”分隔，换行写需要以“-”分隔。</li> <li>一个完整的代码块功能需最少元素包括<code>name</code> 和 <code>task</code>。</li> <li>一个name只能包括一个task。</li> <li>在每一个play当中，都可以使用<code>with_items</code>来定义变量，并通过****的形式来直接使用。</li></ol> <h2 id="_2-playbook组件"><a href="#_2-playbook组件" class="header-anchor">#</a> 2. Playbook组件</h2> <h3 id="_2-1-handlers"><a href="#_2-1-handlers" class="header-anchor">#</a> 2.1. handlers</h3> <p>使用<code>handlers</code>关键字，指明哪些任务可以被调用，与<code>notify</code>配套使用。</p> <ul><li>只有当<code>tasks</code>中的任务<strong>真正执行</strong>以后（<strong>真正的进行实际操作，造成了实际的改变</strong>），<code>handlers</code>中被调用的任务才会执行，否则<code>Playbook</code>不会执行<code>notify</code>中指定的<code>handlers</code>关键字（包括条件判断）。</li> <li><code>handlers</code>中可以有多个任务，被<code>tasks</code>中不同的任务<code>notify</code>。</li> <li>一个<code>task</code>可以同时调用多个<code>handlers</code>。</li> <li><code>handlers</code>可以调用<code>handlers</code>，直接在<code>handlers</code>中使用<code>notify</code>即可。</li></ul> <p>示例内容如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment">#这个是你选择的主机</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token comment">#这个是变量</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">http_port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">max_clients</span><span class="token punctuation">:</span> <span class="token number">200</span>
    <span class="token comment">#远端的执行权限</span>
    <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install Apache
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=<span class="token punctuation">{</span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token punctuation">}</span> state=present
      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> httpd
          <span class="token punctuation">-</span> httpd<span class="token punctuation">-</span>devel
    <span class="token comment"># 确认已安装apache</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure that apache is installed
      <span class="token key atrule">yum</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">state</span><span class="token punctuation">:</span> present
    <span class="token comment"># 利用yum模块来操作</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is at the latest version
      <span class="token key atrule">yum</span><span class="token punctuation">:</span> pkg=httpd state=latest
    <span class="token comment"># 替换配置文件</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> write the apache config file
      <span class="token key atrule">template</span><span class="token punctuation">:</span> src=/srv/httpd.j2 dest=/etc/httpd/conf/httpd.conf
      <span class="token comment"># 触发重启服务器</span>
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> restart apache
    <span class="token punctuation">-</span> <span class="token key atrule">meta</span><span class="token punctuation">:</span> flush_handlers
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is running
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started

  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart apache
      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>执行结果：</p> <p><img src="https://static.xiaoliutalk.cn/img/202302201531210.png" alt="image-20230220153100833"></p> <p><code>handler</code>执行的顺序与<code>handler</code>在<code>playbook</code>中定义的顺序是相同的，与<code>handler</code>被<code>notify</code>的顺序无关。如果需要执行完某些<code>task</code>以后立即执行对应的<code>handler</code>，则需要使用<code>meta</code>：</p> <p>示例内容如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment"># 添加meta进行测试</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> make test1
      <span class="token key atrule">file</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp/test1
        <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> testfile1
    <span class="token comment"># 立即执行之前的task所对应handler</span>
    <span class="token punctuation">-</span> <span class="token key atrule">meta</span><span class="token punctuation">:</span> flush_handlers
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> make test2
      <span class="token key atrule">file</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp/test2
        <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
      <span class="token key atrule">notify</span><span class="token punctuation">:</span> testfile2

  <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> testfile1
      <span class="token key atrule">file</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp/test1/testfile1
        <span class="token key atrule">state</span><span class="token punctuation">:</span> touch
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> testfile2
      <span class="token key atrule">file</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp/test2/testfile2
        <span class="token key atrule">state</span><span class="token punctuation">:</span> touch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>执行结果：</p> <p><img src="https://static.xiaoliutalk.cn/img/202302201537189.png" alt="image-20230220153740881"></p> <h3 id="_2-2-环境变量"><a href="#_2-2-环境变量" class="header-anchor">#</a> 2.2. 环境变量</h3> <h4 id="_2-2-1-自定义环境变量"><a href="#_2-2-1-自定义环境变量" class="header-anchor">#</a> 2.2.1. 自定义环境变量</h4> <p>ansible中设置和使用环境变量的方法很多，通常可以通过用户家目录下的<code>.bashrc</code>、<code>.bash_profile</code>，或者是<code>/etc</code>目录下面的<code>profile</code>，以及<code>profile.d</code>文件夹来自定义环境变量。</p> <p>通过<code>.bash_profile</code>来自定义环境变量，示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span> 
    <span class="token comment"># lineinfile模块，功能有点类似sed，常用功能：对文件的行替换、插入、删除</span>
    <span class="token comment"># 替换ENV_VAR为value，如果regexp未匹配到行的话，就是新增环境变量ENV_VAR</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 为远程主机上的用户指定环境变量
      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span> 
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> ~/.bash_profile
        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> ^ENV_VAR=
        <span class="token key atrule">line</span><span class="token punctuation">:</span> ENV_VAR=value
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 获取刚刚指定的环境变量，并将其保存到自定义变量foo中
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'source ~/.bash_profile &amp;&amp; echo $ENV_VAR'</span>
      <span class="token key atrule">register</span><span class="token punctuation">:</span> foo
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 打印出环境变量
      <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;The variable is <span class="token punctuation">{</span><span class="token punctuation">{</span> foo.stdout <span class="token punctuation">}</span><span class="token punctuation">}</span>&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="_2-2-2-预定义环境变量-未完成"><a href="#_2-2-2-预定义环境变量-未完成" class="header-anchor">#</a> 2.2.2. 预定义环境变量（未完成）</h4> <p>参考 <a href="http://www.ansible.com.cn/docs/playbooks_environment.html" target="_blank" rel="noopener noreferrer">配置环境 (在代理环境中)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>对于某一个<code>Playbook</code>来说，我们可以使用<code>environment</code>选项来为其设置单独的环境变量。</p> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> localhost 	
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">http_proxy</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//example<span class="token punctuation">-</span>proxy<span class="token punctuation">:</span>80/
    <span class="token key atrule">https_proxy</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>// example<span class="token punctuation">-</span>proxy<span class="token punctuation">:</span>443/
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 使用指定的代理服务器下载文件
        <span class="token key atrule">get_url</span><span class="token punctuation">:</span> url=http<span class="token punctuation">:</span>//www.example.com/file.tar.gz dest=~/Downloads/
          <span class="token key atrule">environment</span><span class="token punctuation">:</span> var_proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_2-3-变量"><a href="#_2-3-变量" class="header-anchor">#</a> 2.3. 变量</h3> <p>Ansible中变量的命名规则与其他语言或系统中变量的命名规则非常相似。在<code>ansible</code>中，变量以<strong>英文大小写字母</strong>开头，中间可以包含下划线（_）和数字，应避免变量名中使用大小写字母混合的驼峰式写法。</p> <h4 id="_2-3-1-playbook变量"><a href="#_2-3-1-playbook变量" class="header-anchor">#</a> 2.3.1. Playbook变量</h4> <p>Ansible有多种不同的途径来定义变量。</p> <ul><li><p>通过命令行指定变量，如：<code>ansible-playbook example.yml --extra-vars &quot;foo=bar&quot;</code></p></li> <li><p>使用<code>vars</code>代码块指定变量：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
      <span class="token key atrule">foo</span><span class="token punctuation">:</span> bar
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token comment"># Prints &quot;Variable 'foo' is set to bar&quot;.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;Variable 'foo' is set to <span class="token punctuation">{</span><span class="token punctuation">{</span> foo <span class="token punctuation">}</span><span class="token punctuation">}</span>&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>使用<code>vars_files</code>代码块来引用变量文件：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> vars.yml
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;Variable 'foo' is set to <span class="token punctuation">{</span><span class="token punctuation">{</span> foo <span class="token punctuation">}</span><span class="token punctuation">}</span>&quot;
<span class="token comment"># vars.yml内容</span>
<span class="token punctuation">---</span>
<span class="token key atrule">foo</span><span class="token punctuation">:</span> bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul> <p>示例：通过指定<code>ansible_os_family</code>来在不同的操作系统上安装不同的包的效果：参考：<a href="https://github.com/ansible/ansible/blob/37ae2435878b7dd76b812328878be620a93a30c9/lib/ansible/module_utils/facts.py#L267" target="_blank" rel="noopener noreferrer">A list with OS Family members<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>---
- hosts: example
  vars_files:
- <span class="token punctuation">[</span> <span class="token string">&quot;apache_{{ ansible_os_family }}.yml&quot;</span>, <span class="token string">&quot;apache_default.yml&quot;</span> <span class="token punctuation">]</span>
  tasks:
      - service: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> apache <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>running
<span class="token comment"># apache_RedHat.yml内容</span>
---
apache: httpd
<span class="token comment"># apache_default.yml内容</span>
---
apache: apache2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Ansible会主动读取远程主机的<code>Facts</code>信息，如果获取远程主机的<code>ansible_os_family</code>的值，那将会找到<code>apache_RedHat.yml</code>的变量执行，未找到文件则执行<code>apache_default.yml</code>的变量。</p> <h4 id="_2-3-2-inventory定义变量"><a href="#_2-3-2-inventory定义变量" class="header-anchor">#</a> 2.3.2. Inventory定义变量</h4> <p>在执行Ansible命令时，Ansible默认会从<code>/etc/ansible/host_vars/</code>和<code>/etc/ansible/group_vars/</code>两个目录下读取变量定义，如果没有这两个目录，可以直接手动创建，并且可以在这两个目录中创建与<strong>Hosts文件中主机名</strong>或<strong>组名</strong>同名的文件来定义变量。</p> <p>我们还可以在<code>group_vars</code>和<code>host_vars</code>两个文件夹下定义<code>all</code>文件，来一次性地为所有的主机组和主机定义变量。</p> <h4 id="_2-3-3-注册变量"><a href="#_2-3-3-注册变量" class="header-anchor">#</a> 2.3.3. 注册变量</h4> <p>注册变量，其实就是将操作的结果，包括标准输出（stdout）和标准错误输出（stderr），保存到变量中，然后再根据这个变量的内容来决定下一步的操作。参考环境变量章节进行操作即可。</p> <h4 id="_2-3-4-高阶变量"><a href="#_2-3-4-高阶变量" class="header-anchor">#</a> 2.3.4. 高阶变量</h4> <p><strong>普通变量</strong></p> <p>在Ansible命令行、Hosts文件，或者在Playbook和变量定义文件中定义的变量都  被称为简单变量或普通变量。</p> <p>可以在<code>Playbook</code>中使用双大括号加变量名来读取变量内容，形如<code></code>，如上文中提及到的使用<code>vars</code>代码块指定变量。</p> <p><strong>数组变量</strong></p> <p>由于Ansible是基于Python语言开发的，所以我们也可以称之为列表变量。如：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># Python语法格式</span>
foo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment"># Jinja2语法</span>
foo<span class="token punctuation">|</span>first
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>多级变量</strong></p> <p>多级变量类似于Python中字典概念，Ansible内置变量<code>ansible_eth0</code>就是这样一种变量，它用来保存远程主机上面eth0接口的信息，包括IP地址和子网掩码等。下面我们使用debug模块来展示一下变量<code>ansible_eth0</code>的内容。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> var=ansible_eth0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>执行结果：</p> <p><img src="https://static.xiaoliutalk.cn/img/202302211435794.png" alt=""></p> <p>当我们想要读取其IPv4地址时，可使用如下两种方法实现：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_eth0.ipv4.address <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_eth0<span class="token punctuation">[</span><span class="token string">'ipv4'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'address'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_2-3-5-主机变量和组变量"><a href="#_2-3-5-主机变量和组变量" class="header-anchor">#</a> 2.3.5. 主机变量和组变量</h4> <ul><li><strong>Inventory定义变量</strong>：前文已存在相关内容，这里不再赘述。</li> <li><strong>group_vars和host_vars</strong>：前文已存在相关内容，这里不再赘述。</li> <li><strong>ansible内置变量</strong>：Ansible提供了一些非常有用的内置变量，这里我们列举几个常用的：</li></ul> <table><thead><tr><th>变量</th> <th>参数</th></tr></thead> <tbody><tr><td>groups</td> <td>包含了所有Hosts文件里主机组的一个列表。</td></tr> <tr><td>group_names</td> <td>包含了当前主机所在的所有主机组名的一个列表。</td></tr> <tr><td>inventory_hostname</td> <td>通过Hosts文件定义主机的主机名（与ansible_home不一定相同）。</td></tr> <tr><td>inventory_hostname_short</td> <td>变量inventory_hostname的第1部分，比如inventory_hostname的值是books.ansible.com，那么inventory_hostname_short就是books。</td></tr> <tr><td>play_hosts</td> <td>将执行当前任务的所有主机。</td></tr> <tr><td>hostvars</td> <td>获取到其他主机中的信息。</td></tr></tbody></table> <h4 id="_2-3-6-facts-收集系统信息"><a href="#_2-3-6-facts-收集系统信息" class="header-anchor">#</a> 2.3.6. Facts（收集系统信息）</h4> <p><code>Playbook</code>中所指定的所有主机的系统信息，这些信息我们称之为<code>Facts</code>。在运行任何一个<code>Playbook</code>之前，<code>Ansible</code>默认会先抓取<code>Facts</code>。</p> <p><code>Facts</code>信息包括（但不仅限于）<strong>远程主机的CPU类型、IP地址、磁盘空间、操作系统信息以及网络接口信息</strong>等，这些信息对于<code>Playbook</code>的运行至关重要。我们可以根据这些信息来决定是否要继续运行下一步任务，或者将这些信息写入某个配置文件中。</p> <p>使用<code>setup</code>模块来获取对应主机上面的所有可用的<code>Facts</code>信息：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible <span class="token builtin class-name">test</span> <span class="token parameter variable">-m</span> setup
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在<code>Playbook</code>任务中，如果不需要<code>Facts</code>信息，我们可以在<code>Playbook</code>中设置 <code>gather_facts: no</code> 来暂时让Ansible在执行<code>Playbook</code>任务之前跳过收集远程主机<code>Facts</code>信息这一步，这样可以为任务节省几秒钟的时间：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>💡 如果远程主机上安装了<code>Facter</code>或<code>Ohai</code>，那么<code>Ansible</code>将会把这两个软件所生成的<code>Facts</code>信息也给收集回来，<code>Facts</code>变量名分别以<code>facter_</code>和<code>ohai_</code>开头进行标示。</p> <h4 id="_2-3-7-加密模块vault"><a href="#_2-3-7-加密模块vault" class="header-anchor">#</a> 2.3.7. 加密模块Vault</h4> <p>运行某些任务时，不可避免地会接触到一些密码或其他敏感数据，这些数据有可能是管理员密码、SSH私钥或远程主机的认证信息，<code>Ansible</code>自带的<code>Vault</code>加密功能，<code>Vault</code>可以将经过加密的密码和敏感数据同<code>Playbook</code>存储在一起。</p> <p>假如使用API key的方式来访问一个服务的API，这个API key就存储在一个纯文本文件<code>vars/api_key.yml</code>中：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> appserver
  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> vars/api_key.yml
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Connect to service with our API key.
          <span class="token key atrule">command</span><span class="token punctuation">:</span> connect_to_service
          <span class="token key atrule">environment</span><span class="token punctuation">:</span>
              <span class="token key atrule">SERVICE_API_KEY</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ myapp_service_api_key }}&quot;</span>
<span class="token comment"># vars/api_key.yml</span>
<span class="token punctuation">---</span>
<span class="token key atrule">myapp_service_api_key</span><span class="token punctuation">:</span> “yJJvPqhqgxyPZMispRycaVMBmBWPqYDf3DFanPxAMAm4UZcw&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>此时，我们可以使用<code>ansible-vault</code>进行加密：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ansible-vault encrypt api_key.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>ansible-vault</code>常用参数：</p> <table><thead><tr><th>变量</th> <th>参数</th></tr></thead> <tbody><tr><td>encrypt</td> <td>加密文件。</td></tr> <tr><td>decrypt</td> <td>解密文件。</td></tr> <tr><td>edit</td> <td>用于编辑ansible-vault加密过的文件。</td></tr> <tr><td>rekey</td> <td>重新修改已被加密文件的密码。</td></tr> <tr><td>create</td> <td>创建一个新文件，并直接对其进行加密。</td></tr> <tr><td>view</td> <td>查看经过加密的文件。</td></tr></tbody></table> <h4 id="_2-3-8-变量优先级"><a href="#_2-3-8-变量优先级" class="header-anchor">#</a> 2.3.8. 变量优先级</h4> <p>Ansible官方给出了如下由高到低的优先级排序：</p> <ol><li>在命令行中定义的变量（即用-e定义的变量）。</li> <li>在Inventory中定义的连接变量（比如ansible_ssh_user）。</li> <li>大多数的其他变量（命令行转换、play中的变量、included的变量、role中的变量等）。</li> <li>在Inventory定义的其他变量。</li> <li>由系统通过gather_facts方法发现的Facts。</li> <li>Role默认变量。</li></ol> <h3 id="_2-4-流程控制"><a href="#_2-4-流程控制" class="header-anchor">#</a> 2.4. 流程控制</h3> <h4 id="_2-4-1-条件判断-when"><a href="#_2-4-1-条件判断-when" class="header-anchor">#</a> 2.4.1. 条件判断-when</h4> <p>ansible中，条件判断的关键字是 <code>when</code> 。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 如果ansible_distribution的值是CentOS，则打印System release is centos</span>
<span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span>
      <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;System release is centos&quot;</span>
    <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_distribution == &quot;CentOS&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><code>when</code>关键字中引用变量时，变量名不需要加<code></code>。</li> <li>ansible使用<code>jinja2</code>模板引擎，在ansible中也可以直接使用<code>jinja2</code>的这些运算符。如加、减、乘、除和比较（==表示相等，！=表示不相等，&gt;=表示大于等于，等等）。逻辑运算符支持<code>and</code>（与）、<code>or</code>（或）、<code>not</code>（非），可以使用小括号来对逻辑运算符进行分组使用。</li> <li>在少数<code>Jinja2</code>并不能发挥强大功能的场景中，我们可以使用Python的内置方法来进行补充，比如：<code>string.split</code>和<code>[number].is_signed（）</code>。</li></ul> <h4 id="_2-4-2-条件判断-changed-when-failed-when"><a href="#_2-4-2-条件判断-changed-when-failed-when" class="header-anchor">#</a> 2.4.2. 条件判断-changed_when，failed_when</h4> <p><strong>changed_when</strong></p> <p>当我们使用某些模块时，如果不使用<code>changed_when</code>语句，<code>Ansible</code>将永远返回<code>changed</code>。如果使用<code>changed_when</code>语句，并结合注册变量对任务返回结果进行判断后，再来决定是否显示状态为<code>changed</code>，将更加符合我们的实际需求。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Test changed_when
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span>
      <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;ansible change test&quot;</span>
    <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> 0 <span class="token punctuation">&gt;</span> 1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>failed_when</strong></p> <p>有一些命令会将自己的运行结果写入标准错误输出<code>stderr</code>中，而不是通常的标准输出<code>stdout</code>中，这时可以使用<code>failed_when</code>来对结果进行判断，从而告诉<code>Ansible</code>真正的运行结果到底是成功还是失败。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>---
- hosts: <span class="token builtin class-name">test</span>
  gather_facts: no
  remote_user: root
  tasks:
  - name: 通过CLI导入Jenkins任务
    shell: <span class="token operator">&gt;</span>
        <span class="token function">java</span> <span class="token parameter variable">-jar</span> /opt/jenkins-cli.jar <span class="token parameter variable">-s</span> http://localhost:8080/
        create-job <span class="token string">&quot;My Job&quot;</span> <span class="token operator">&lt;</span> /usr/local/my-job.xml
    register: <span class="token function">import</span>
    failed_when: <span class="token string">&quot;import.stderr and 'already exists' not in import.stderr&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_2-4-3-条件判断-ignore-errors"><a href="#_2-4-3-条件判断-ignore-errors" class="header-anchor">#</a> 2.4.3. 条件判断-ignore_errors</h4> <p>一些必须运行的命令或脚本会报一些错误，会直接导致<code>Playbook</code>运行中断。这时候，我们可以在相关任务中添加<code>ignore_errors: true</code>来屏蔽所有错误信息，<code>Ansible</code>也将视该任务运行成功。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">ignore_errors</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">&quot;ls -alh /&quot;</span>
    <span class="token key atrule">register</span><span class="token punctuation">:</span> ls
    <span class="token key atrule">changed_when</span><span class="token punctuation">:</span> <span class="token string">&quot;'root' in ls&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_2-4-4-block块"><a href="#_2-4-4-block块" class="header-anchor">#</a> 2.4.4. Block块</h4> <p>在ansible中，可以使用<code>block</code>关键字将多个任务整合成一个块，这个块将被当做一个整体，我们可以对这个块添加判断条件，块功能可以将任务进行分组，并且可以在块级别上应用任务变量。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 根据系统版本来区分apache包名称，路径，并安装apache</span>
<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
      <span class="token comment"># Install and configure Apache on RedHat/CentOS hosts.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">block</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present
          <span class="token punctuation">-</span> <span class="token key atrule">template</span><span class="token punctuation">:</span> src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf
          <span class="token punctuation">-</span> <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == 'RedHat'
      <span class="token key atrule">sudo</span><span class="token punctuation">:</span> yes

      <span class="token comment"># Install and configure Apache on Debian/Ubuntu hosts.</span>
      <span class="token punctuation">-</span> <span class="token key atrule">block</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">apt</span><span class="token punctuation">:</span> name=apache2 state=present
          <span class="token punctuation">-</span> <span class="token key atrule">template</span><span class="token punctuation">:</span> src=httpd.conf.j2 dest=/etc/apache2/apache2.conf
          <span class="token punctuation">-</span> <span class="token key atrule">service</span><span class="token punctuation">:</span> name=apache2 state=started enabled=yes
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ansible_os_family == 'Debian'
      <span class="token key atrule">sudo</span><span class="token punctuation">:</span> yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>块功能也可以用来处理任务的异常。简单理解为try...catch...finally即可。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">block</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Shell script to connect the app to a monitoring service.
        <span class="token key atrule">script</span><span class="token punctuation">:</span> monitoring<span class="token punctuation">-</span>connect.sh
        <span class="token key atrule">rescue</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 只有脚本报错时才执行
          <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;There was an error in the block.&quot;
        <span class="token key atrule">always</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 无论结果如何都执行
          <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;This always executes.&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当块中的任意任务出错时，<code>rescue</code>关键字对应的代码块就会被执行，而<code>always</code>关键字对应的代码块无论如何都会被执行。</p> <h3 id="_2-5-循环"><a href="#_2-5-循环" class="header-anchor">#</a> 2.5. 循环</h3> <h4 id="_2-5-1-with-items-with-flattened"><a href="#_2-5-1-with-items-with-flattened" class="header-anchor">#</a> 2.5.1. with_items，with_flattened</h4> <p><code>with_items</code>、 <code>with_flattened</code>关键字会把返回的列表信息自动处理，将每一条信息单独放在一个名为<code>item</code>的变量中，我们只要获取到名为<code>item</code>变量的变量值，即可循环的获取到列表中的每一条信息。</p> <p>示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add several users
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">{</span><span class="token punctuation">{</span> item <span class="token punctuation">}</span><span class="token punctuation">}</span> state=present groups=wheel
      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> testuser1
         <span class="token punctuation">-</span> testuser2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>自定义列表中的每一个条目都是一个字典，可以通过<code>item.key</code>获取对应的值。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add several users
      <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">{</span><span class="token punctuation">{</span> item.name <span class="token punctuation">}</span><span class="token punctuation">}</span> state=present groups=<span class="token punctuation">{</span><span class="token punctuation">{</span> item.groups <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 
          <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'testuser1'</span>
          <span class="token key atrule">groups</span><span class="token punctuation">:</span> <span class="token string">'wheel'</span>
        <span class="token punctuation">-</span> 
          <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'testuser2'</span>
          <span class="token key atrule">groups</span><span class="token punctuation">:</span> <span class="token string">'root'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_2-5-2-with-list"><a href="#_2-5-2-with-list" class="header-anchor">#</a> 2.5.2. with_list</h4> <p><code>with_items</code>、 <code>with_flattened</code>关键字会把列表中的值按顺序进行执行，但是<code>with_list</code>关键字会把列表按照整体进行执行。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span>
      <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;{{item}}&quot;</span>
    <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span>
    <span class="token punctuation">-</span> <span class="token punctuation">[</span> a<span class="token punctuation">,</span> b <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>with_items</code>打印：</p> <p><img src="https://static.xiaoliutalk.cn/img/202302241104386.png" alt="image-20230224110427182"></p> <p><code>with_list</code>打印：</p> <p><img src="https://static.xiaoliutalk.cn/img/202302241105272.png" alt="image-20230224110502712"></p> <h4 id="_2-5-3-with-together"><a href="#_2-5-3-with-together" class="header-anchor">#</a> 2.5.3. with_together</h4> <p>如果你想得到<code>(a, 1)</code>和<code>(b, 2)</code>之类的集合.可以使用<code>with_together</code>：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;<span class="token punctuation">{</span><span class="token punctuation">{</span> item.0 <span class="token punctuation">}</span><span class="token punctuation">}</span> and <span class="token punctuation">{</span><span class="token punctuation">{</span> item.1 <span class="token punctuation">}</span><span class="token punctuation">}</span>&quot;
      <span class="token key atrule">with_together</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token punctuation">[</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span> <span class="token punctuation">]</span>
        <span class="token punctuation">-</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_2-5-4-with-cartesian"><a href="#_2-5-4-with-cartesian" class="header-anchor">#</a> 2.5.4. with_cartesian</h4> <p><code>with_cartesian</code>关键字的作用就是将每个小列表中的元素按照<code>笛卡尔积</code>的方式组合。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;<span class="token punctuation">{</span><span class="token punctuation">{</span> item.0 <span class="token punctuation">}</span><span class="token punctuation">}</span> and <span class="token punctuation">{</span><span class="token punctuation">{</span> item.1 <span class="token punctuation">}</span><span class="token punctuation">}</span>&quot;
      <span class="token key atrule">with_cartesian</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token punctuation">[</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span> <span class="token punctuation">]</span>
        <span class="token punctuation">-</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://static.xiaoliutalk.cn/img/202302241418201.png" alt="image-20230224141656065"></p> <h4 id="_2-5-5-with-sequence"><a href="#_2-5-5-with-sequence" class="header-anchor">#</a> 2.5.5. with_sequence</h4> <p><code>with_sequence</code> 关键字可以以数字顺序生成一组序列。你可以指定起始值（<strong>start</strong>）、终止值（<strong>end</strong>）、以及可选的步长值（<strong>stride</strong>），和数据格式化的功能（<strong>format</strong>）。</p> <p>示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">file</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/testdir/testdir/test{{ item }}&quot;</span>
      <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">with_sequence</span><span class="token punctuation">:</span>
      start=2
      end=10
      stride=2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_2-5-6-with-dict"><a href="#_2-5-6-with-dict" class="header-anchor">#</a> 2.5.6. with_dict</h4> <p><code>with_dict</code>关键字可以处理字典变量，通过<code>key</code>关键字和<code>value</code>关键字分别获取到字典中键值对的键和值。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span>
      <span class="token key atrule">alice</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Alice Appleworth
        <span class="token key atrule">telephone</span><span class="token punctuation">:</span> 123<span class="token punctuation">-</span>456<span class="token punctuation">-</span><span class="token number">7890</span>
      <span class="token key atrule">bob</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Bob Bananarama
        <span class="token key atrule">telephone</span><span class="token punctuation">:</span> 987<span class="token punctuation">-</span>654<span class="token punctuation">-</span><span class="token number">3210</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Print phone records
      <span class="token key atrule">debug</span><span class="token punctuation">:</span> msg=&quot;User <span class="token punctuation">{</span><span class="token punctuation">{</span> item.key <span class="token punctuation">}</span><span class="token punctuation">}</span> is <span class="token punctuation">{</span><span class="token punctuation">{</span> item.value.name <span class="token punctuation">}</span><span class="token punctuation">}</span> (<span class="token punctuation">{</span><span class="token punctuation">{</span> item.value.telephone <span class="token punctuation">}</span><span class="token punctuation">}</span>)&quot;
      <span class="token key atrule">with_dict</span><span class="token punctuation">:</span> <span class="token string">&quot;{{users}}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_2-5-7-with-subelements-未完成"><a href="#_2-5-7-with-subelements-未完成" class="header-anchor">#</a> 2.5.7. with_subelements（未完成）</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">users</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alice
        <span class="token key atrule">authorized</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> /tmp/alice/onekey.pub
          <span class="token punctuation">-</span> /tmp/alice/twokey.pub
        <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
            <span class="token key atrule">password</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>password
            <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;%&quot;</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;127.0.0.1&quot;</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;::1&quot;</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;localhost&quot;</span>
            <span class="token key atrule">privs</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;*.*:SELECT&quot;</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;DB1.*:ALL&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bob
        <span class="token key atrule">authorized</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> /tmp/bob/id_rsa.pub
        <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
            <span class="token key atrule">password</span><span class="token punctuation">:</span> other<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>password
            <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;db1&quot;</span>
            <span class="token key atrule">privs</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;*.*:SELECT&quot;</span>
              <span class="token punctuation">-</span> <span class="token string">&quot;DB2.*:ALL&quot;</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">user</span><span class="token punctuation">:</span> name=<span class="token punctuation">{</span><span class="token punctuation">{</span> item.name <span class="token punctuation">}</span><span class="token punctuation">}</span> state=present generate_ssh_key=yes
      <span class="token key atrule">with_items</span><span class="token punctuation">:</span> <span class="token string">&quot;{{users}}&quot;</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">authorized_key</span><span class="token punctuation">:</span> <span class="token string">&quot;user={{ item.0.name }} key='{{ lookup('file', item.1) }}'&quot;</span>
      <span class="token key atrule">with_subelements</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> users
         <span class="token punctuation">-</span> authorized
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="_2-5-8-with-file"><a href="#_2-5-8-with-file" class="header-anchor">#</a> 2.5.8. with_file</h4> <p><code>with_file</code>关键字获取到<code>ansible</code>主机中的文件内容。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ item }}&quot;</span>
      <span class="token key atrule">with_file</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/1.txt
      <span class="token punctuation">-</span> /tmp/2.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_2-5-9-with-fileglob"><a href="#_2-5-9-with-fileglob" class="header-anchor">#</a> 2.5.9. with_fileglob</h4> <p><code>with_fileglob</code>关键字用来匹配文件名称。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ item }}&quot;</span>
      <span class="token key atrule">with_fileglob</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /tmp/*
      <span class="token punctuation">-</span> /tmp/<span class="token important">*.???</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2-6-任务间流程控制"><a href="#_2-6-任务间流程控制" class="header-anchor">#</a> 2.6. 任务间流程控制</h3> <h4 id="_2-6-1-任务委托"><a href="#_2-6-1-任务委托" class="header-anchor">#</a> 2.6.1. 任务委托</h4> <p>Ansible的任务委托功能可以在特定的主机上运行任务。<code>delegate_to</code>可以把某一个任务放在委托的机器上执行。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># Test delegate_to</span>
<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Test delegate_to
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Test delegate_to
      <span class="token key atrule">ansible.builtin.debug</span><span class="token punctuation">:</span>
        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;ansible delegate_to test&quot;</span>
      <span class="token key atrule">delegate_to</span><span class="token punctuation">:</span> 127.0.0.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_2-6-2-任务暂停"><a href="#_2-6-2-任务暂停" class="header-anchor">#</a> 2.6.2. 任务暂停</h4> <p>有些情况下，一些任务的运行需要等待一些状态的恢复，比如某一台主机或者应用刚刚重启，我们需要等待它上面的某个端口开启，此时我们就不得不将正在运行的任务暂停，直到其状态满足我们需求。</p> <p><code>Ansible</code>提供了wait_for模块以实现任务暂停的需求，<code>wait_for</code>模块常用参数：</p> <table><thead><tr><th>变量</th> <th>参数</th></tr></thead> <tbody><tr><td>connect_timeout</td> <td>在下一个任务执行之前等待连接的超时时间</td></tr> <tr><td>delay</td> <td>等待一个端口或者文件或者连接到指定的状态时，默认超时时间为300秒，在这等待的300s的时间里，wait_for模块会一直轮询指定的对象是否到达指定的状态，delay即为多长时间轮询一次状态。</td></tr> <tr><td>host</td> <td>wait_for模块等待的主机的地址，默认为127.0.0.1</td></tr> <tr><td>port</td> <td>wait_for模块待待的主机的端口</td></tr> <tr><td>path</td> <td>文件路径，只有当这个文件存在时，下一任务才开始执行，即等待该文件创建完成</td></tr> <tr><td>state</td> <td>等待的状态，即等待的文件或端口或者连接状态达到指定的状态时，下一个任务开始执行。当等待的对象为端口时，状态有started，stoped，即端口已经监听或者端口已经关闭；当等待的对象为文件时，状态有present(存在)或者started，absent(不存在)，即文件已创建或者删除；当等待的对象为一个连接时，状态有drained，即连接已建立。默认为started</td></tr> <tr><td>timeout</td> <td>wait_for的等待的超时时间，默认为300秒</td></tr></tbody></table> <p>示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Wait for webserver to start.
  <span class="token key atrule">local_action</span><span class="token punctuation">:</span>
      <span class="token key atrule">module</span><span class="token punctuation">:</span> wait_for
      <span class="token key atrule">host</span><span class="token punctuation">:</span> webserver1
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">300</span>
      <span class="token key atrule">state</span><span class="token punctuation">:</span> started
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-7-交互式提示"><a href="#_2-7-交互式提示" class="header-anchor">#</a> 2.7. 交互式提示</h3> <p>Ansible任务运行的过程中需要用户输入一些数据，<code>vars_prompt</code>关键字用来处理上述这种与用户交互的情况。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">vars_prompt</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> share_user
    <span class="token key atrule">prompt</span><span class="token punctuation">:</span> <span class="token string">&quot;What is your network username?&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> share_pass
    <span class="token key atrule">prompt</span><span class="token punctuation">:</span> <span class="token string">&quot;What is your network password?&quot;</span>
    <span class="token key atrule">private</span><span class="token punctuation">:</span> yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>vars_prompt</code>几个常用的选项：</p> <table><thead><tr><th>变量</th> <th>参数</th></tr></thead> <tbody><tr><td>private</td> <td>该值为yes，即用户所有的输入在命令中默认都是不可见的。</td></tr> <tr><td>default</td> <td>为变量设置默认值，以节省用户输入时间。</td></tr> <tr><td>confirm</td> <td>特别适合输入密码的情况，如果将值设为yes，则会要求用户输入两次，以增加输入的正确性。</td></tr></tbody></table> <h3 id="_2-8-tags"><a href="#_2-8-tags" class="header-anchor">#</a> 2.8. Tags</h3> <p>Ansible的标签（<code>Tags</code>）功能可以给角色（<code>Roles</code>）、文件、单独的任务甚至整个<code>Playbook</code>打上标签，然后利用这些标签来指定要运行Playbook中的个别任务，或不执行指定的任务。</p> <p>示例如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment"># 可以给整个Playbook的所有任务打一个标签</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> test
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
      <span class="token comment"># 给角色打的标签将会应用于角色下所有的任务</span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'tomcat'</span><span class="token punctuation">,</span> <span class="token string">'app'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Notify on completion.
            <span class="token key atrule">local_action</span><span class="token punctuation">:</span>
               <span class="token key atrule">module</span><span class="token punctuation">:</span> osx_say
               <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">&quot;{{inventory_hostname}} is finished!&quot;</span>
               <span class="token key atrule">voice</span><span class="token punctuation">:</span> Zarvox
            <span class="token key atrule">tags</span><span class="token punctuation">:</span>
               <span class="token punctuation">-</span> notifications
               <span class="token punctuation">-</span> say
          <span class="token punctuation">-</span> <span class="token key atrule">include</span><span class="token punctuation">:</span> foo.yml
            <span class="token key atrule">tags</span><span class="token punctuation">:</span> foo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/11, 11:55:33</span></div></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/d6ca03/" class="prev">ansible的Ad-Hoc</a></span> <span class="next"><a href="/pages/7ba1c1/">ansible进阶技巧</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/82c021/"><div>
            kubernetes控制器-Service
            <!----></div></a> <span class="date">08-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/d5cb3c/"><div>
            kubernetes控制器-Deployment
            <!----></div></a> <span class="date">08-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/e33737/"><div>
            kubernetes调度基础
            <!----></div></a> <span class="date">07-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:248920070@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xiaoliutalk" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/xiaoliuTalk" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span><a href="https://ipw.cn/ipv6webcheck/?site=www.xiaoliutalk.cn" title="本站支持IPv6访问" target="_blank"><img style="display:inline-block;vertical-align:middle" alt="本站支持IPv6访问" src="https://static.ipw.cn/icon/ipv6-s3.svg"></a>         <a href="https://ipw.cn/ssl/?site=www.xiaoliutalk.cn" title="本站支持SSL安全访问" target="_blank"><img style="display:inline-block;vertical-align:middle" alt="本站支持SSL安全访问" src="https://static.ipw.cn/icon/ssl-s3.svg"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;left:10px;bottom:0px;width:135px;height:200px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="200" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:200px;"></canvas></div><div></div></div></div>
    <script src="/assets/js/app.44d32a86.js" defer></script><script src="/assets/js/3.5c73636d.js" defer></script><script src="/assets/js/2.db635a7e.js" defer></script><script src="/assets/js/104.e24987b7.js" defer></script>
  </body>
</html>
