(window.webpackJsonp=window.webpackJsonp||[]).push([[54],{426:function(s,a,r){"use strict";r.r(a);var t=r(1),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"harbor安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor安装"}},[s._v("#")]),s._v(" harbor安装")]),s._v(" "),a("h2",{attrs:{id:"harbor安装-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor安装-2"}},[s._v("#")]),s._v(" harbor安装")]),s._v(" "),a("h3",{attrs:{id:"前置工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前置工作"}},[s._v("#")]),s._v(" 前置工作")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.xiaoliutalk.cn/pages/4b7e78",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker离线安装+升级"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.xiaoliutalk.cn/pages/384991/",target:"_blank",rel:"noopener noreferrer"}},[s._v("docker-compose离线安装+升级"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"离线安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#离线安装"}},[s._v("#")]),s._v(" 离线安装")]),s._v(" "),a("h4",{attrs:{id:"_1-下载安装包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载安装包"}},[s._v("#")]),s._v(" 1. 下载安装包")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/goharbor/harbor/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方地址"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#后台下载")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/goharbor/harbor/releases/download/v2.4.3/harbor-offline-installer-v2.4.3.tgz "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n或者\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/goharbor/harbor/releases/download/v2.4.3/harbor-offline-installer-v2.4.3.tgz\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_2-解压"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-解压"}},[s._v("#")]),s._v(" 2. 解压")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxvf")]),s._v(" harbor-offline-installer-v2.4.3.tgz "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" /opt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_3-调整配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-调整配置"}},[s._v("#")]),s._v(" 3. 调整配置")]),s._v(" "),a("p",[s._v("从 "),a("code",[s._v("harbor.yml.tmpl")]),s._v(" 复制一个 "),a("code",[s._v("harbor.yml")]),s._v(" ，然后修改前面几行，自定义 "),a("code",[s._v("hostname")]),s._v(" , "),a("code",[s._v("port")]),s._v(" 禁用 "),a("code",[s._v("https")]),s._v(" ，设置管理员密码，")]),s._v(" "),a("p",[s._v("注：数据存储路径放在 "),a("code",[s._v("/opt/harbor/data")]),s._v(" 下。映射到docker容器里面的/storage目录下。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/harbor\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" harbor.yml.tmpl harbor.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.7.4\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#https:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  port: 443")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  certificate: /your/certificate/path")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  private_key: /your/private/key/path")]),s._v("\n \n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("harbor_admin_password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Harbor12345\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("data_volume")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /opt/harbor/data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h4",{attrs:{id:"_4-安装并启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装并启动"}},[s._v("#")]),s._v(" 4. 安装并启动")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("./install.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"_5-登陆"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-登陆"}},[s._v("#")]),s._v(" 5. 登陆")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http://192.168.7.4:10000/harbor/ \nadmin/Harbor12345\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202208261458183.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"设置开机自启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置开机自启动"}},[s._v("#")]),s._v(" 设置开机自启动")]),s._v(" "),a("p",[s._v("参考博主："),a("a",{attrs:{href:"https://blog.csdn.net/weixin_43219672",target:"_blank",rel:"noopener noreferrer"}},[s._v("CSDN 摸鱼鱼"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("重启harbor服务器发现主机重启之后harbor不能自己起来，"),a("code",[s._v("docker-compose restart")]),s._v(" 容器也会报错，查找资料发现问题在于容器只有在 "),a("code",[s._v("docker-compose up")]),s._v(" 时，才会按照 "),a("code",[s._v("depends_on")]),s._v(" 定义的顺序启动。\ndocker 本身并不记录容器之间的依赖顺序，容器们的重启是相互独立的，各自独立的重启导致服务器重启后，harbor 无法正常启动。")]),s._v(" "),a("p",[s._v("查看 harbor 目录下的 "),a("code",[s._v("docker-compose.yml")]),s._v(" 会发现，所有的 containers 都配置了 "),a("code",[s._v("restart:always:")])]),s._v(" "),a("p",[s._v("这表示所有的容器在意外关闭后都会自动重启，比如 docker 重启或服务器重启。（手动 stop 不会自动重启）")]),s._v(" "),a("p",[s._v("但是我在手动运行 "),a("code",[s._v("docker-compose restart")]),s._v(" ，发现有几个 container 并没有自动重启：")]),s._v(" "),a("p",[s._v("尝试将 harbor 配成 systemd 的 service，添加配置文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v("/usr/lib/systemd/system/harbor.service"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Harbor\nAfter=docker.service systemd-networkd.service systemd-resolved.service\nRequires=docker.service\nDocumentation=https://github.com/goharbor/harbor\n\n[Service]\nType=simple\nRestart=on-failure\nRestartSec=5\n##########docker-compose和harbor的安装位置\nExecStart=/usr/local/bin/docker-compose -f  /opt/harbor/docker-compose.yml up\nExecStop=/usr/local/bin/docker-compose -f /opt/harbor/docker-compose.yml down\n\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置开机启动")]),s._v("\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" harbor\nsystemctl start harbor\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("重启之后，harbor也能自动重启了。")]),s._v(" "),a("h2",{attrs:{id:"harbor磁盘清理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor磁盘清理"}},[s._v("#")]),s._v(" harbor磁盘清理")]),s._v(" "),a("p",[s._v("按下面步骤执行成功")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("1.停止docker harbor\ncd /export/harbor/harbor/\n/usr/local/bin/docker-compose stop\n\n2.预览运行效果\ndocker run -it --name gc --rm --volumes-from registry vmware/registry:2.6.2-photon garbage-collect --dry-run /etc/registry/config.yml\n\n3.执行删除\ndocker run -it --name gc --rm --volumes-from registry vmware/registry:2.6.2-photon garbage-collect  /etc/registry/config.yml\n\n4.重启harbor\n/usr/local/bin/docker-compose start\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"配置镜像代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置镜像代理"}},[s._v("#")]),s._v(" 配置镜像代理")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://goharbor.io/docs/2.5.0/administration/configure-proxy-cache/",target:"_blank",rel:"noopener noreferrer"}},[s._v("配置镜像代理"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);