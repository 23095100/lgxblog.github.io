(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{422:function(e,t,a){"use strict";a.r(t);var s=a(1),n=Object(s.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"kubernetes控制器-deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes控制器-deployment"}},[e._v("#")]),e._v(" kubernetes控制器-Deployment")]),e._v(" "),t("p",[e._v("学习Deployment之前，首先要清楚两个概念：")]),e._v(" "),t("ul",[t("li",[t("strong",[e._v("无状态应用")]),e._v("：任意一个Web请求端提出请求时，请求本身包含了响应端为响应这一请求所需的全部信息（认证信息等）。")]),e._v(" "),t("li",[t("strong",[e._v("有状态应用")]),e._v("：Web请求端的请求必须被提交到保存有其相关状态信息（比如session）的服务器上，否则这些请求可能无法被理解，这也就意味着在此模式下服务器端无法对用户请求进行自由调度。")])]),e._v(" "),t("p",[e._v("分辨有无状态应用的关键点就在数据的存储位置，存储在客户端的就是无状态应用，存储在服务端的就是有状态应用。")]),e._v(" "),t("p",[e._v("而Deployment管理的就是"),t("strong",[e._v("无状态应用")]),e._v("。kubernetes中也有针对有状态应用的控制器Statefulset，但本篇文章不进行讲解。")]),e._v(" "),t("h2",{attrs:{id:"_1-deployment的工作原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-deployment的工作原理"}},[e._v("#")]),e._v(" 1. Deployment的工作原理")]),e._v(" "),t("h3",{attrs:{id:"_1-1-水平扩缩"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-水平扩缩"}},[e._v("#")]),e._v(" 1.1. 水平扩缩")]),e._v(" "),t("p",[e._v("了解Deployment的工作原理之前，我们先新建一个Deployment，新建 "),t("code",[e._v("Deployment.yml")]),e._v(" 如下：")]),e._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" apps/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" Deployment\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("deployment\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("deployment\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("deployment\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("deployment\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("latest\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"128Mi"')]),e._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"500m"')]),e._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("containerPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("80")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br"),t("span",{staticClass:"line-number"},[e._v("17")]),t("br"),t("span",{staticClass:"line-number"},[e._v("18")]),t("br"),t("span",{staticClass:"line-number"},[e._v("19")]),t("br"),t("span",{staticClass:"line-number"},[e._v("20")]),t("br"),t("span",{staticClass:"line-number"},[e._v("21")]),t("br"),t("span",{staticClass:"line-number"},[e._v("22")]),t("br"),t("span",{staticClass:"line-number"},[e._v("23")]),t("br")])]),t("p",[e._v("下面我们画一张图分析一下Deployment的结构：")]),e._v(" "),t("div",{staticClass:"center-container"},[t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://static.xiaoliutalk.cn/img/202308101622967.jpg",alt:"Deployment"}})]),t("p",[e._v("而从这个Deployment，我们能看出来，控制器的结构如图所示，"),t("strong",[e._v("由上半部分的控制器定义（包括期望状态），加上下半部分的被控制对象的模板（template）组成的")]),e._v("。")]),e._v(" "),t("p",[e._v("创建这个Deployment，并查看Deployment的状态：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-f")]),e._v(" Deployment.yml\nkubectl get deployments.apps\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])]),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308101445222.png",alt:""}})])]),t("ul",[t("li",[t("strong",[e._v("READY")]),e._v("：当前已经可用的Pod的个数/用户期望的Pod副本个数（spec.replicas的值）。")]),e._v(" "),t("li",[t("strong",[e._v("UP-TO-DATE")]),e._v("：当前处于最新版本的Pod的个数，所谓最新版本指的是Pod的Spec部分与Deployment里Pod模板里定义的完全一致。")]),e._v(" "),t("li",[t("strong",[e._v("AVAILABLE")]),e._v("：当前已经可用的Pod的个数，即：既是Running状态，又是最新版本，并且已经处于Ready（健康检查正确）状态的Pod的个数。")])]),e._v(" "),t("p",[e._v("而在所有API对象的Metadata里，都有一个字段叫作"),t("strong",[e._v("ownerReference")]),e._v("，用于保存当前这个API对象的拥有者（Owner）的信息。")]),e._v(" "),t("p",[e._v("而"),t("strong",[e._v("Deployment实际操纵的是ReplicaSet")]),e._v("。在创建完Deployment之后，Namespace中多出了一个ReplicaSet，这时，我们查看ReplicaSet的yaml中的ownerReference，就能找到依据：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl get replicasets.apps "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-o")]),e._v(" yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("grep")]),e._v(" ownerReference "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-A")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("10")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308101457265.png",alt:""}})])]),t("p",[e._v("Pod的的拥有者（Owner）是ReplicaSet，而ReplicaSet的拥有者（Owner）是Deployment。而三者之间的关系，实际上是一种“"),t("strong",[e._v("层层控制")]),e._v("”的关系。")]),e._v(" "),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308101726851.svg",alt:"releations"}})])]),t("p",[e._v("而实现水平扩缩就简单了，Deployment通过控制ReplicaSet的副本数就能实现。")]),e._v(" "),t("h3",{attrs:{id:"_1-2-滚动更新"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-滚动更新"}},[e._v("#")]),e._v(" 1.2. 滚动更新")]),e._v(" "),t("p",[e._v("我们也是先执行一次滚动更新，需要注意的是只有"),t("strong",[e._v("spec.template")]),e._v("（Pod模板）更新时才会触发Deployment的更新。如更改CPU，镜像等等。")]),e._v(" "),t("p",[e._v("执行滚动更新有两种方式，可以更改yaml文件后使用 "),t("code",[e._v("kubectl apply -f")]),e._v(" 进行更新，也可以使用 "),t("code",[e._v("kubectl edit")]),e._v(" 进行编辑Deployment来更新。我们这里把nginx的版本号由 "),t("code",[e._v("latest")]),e._v(" 改为 "),t("code",[e._v("1.25.1")]),e._v("：")]),e._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[e._v("    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("deployment\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" nginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("1.25.1\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br")])]),t("p",[e._v("使用 "),t("code",[e._v("kubectl apply -f")]),e._v(" 进行更新：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("-f")]),e._v(" Deployment.yml\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("查看Deployment的Events来观察滚动更新的过程：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl describe deployments.apps nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308101713055.png",alt:""}})])]),t("ol",[t("li",[e._v("Deployment创建一个新ReplicaSet、这个ReplicaSet叫 "),t("code",[e._v("nginx-deployment-cb699c677")]),e._v("，并且这个新ReplicaSet的初始Pod副本数是0。")]),e._v(" "),t("li",[e._v("Deployment将旧ReplicaSet "),t("code",[e._v("nginx-deployment-7c864f7c")]),e._v(" 由三个收缩为2个。并把新ReplicaSet "),t("code",[e._v("nginx-deployment-cb699c677")]),e._v(" 扩展为1个。")]),e._v(" "),t("li",[e._v("新ReplicaSet和旧ReplicaSet分别进行水平扩容和水平收缩，直到新ReplicaSet的副本数为3，旧ReplicaSet的副本数为0，就完成了这次滚动更新。")])]),e._v(" "),t("p",[e._v("查看集群内ReplicaSet的最终状态，也正如我们预想的那样，旧ReplicaSet已经水平收缩为0：")]),e._v(" "),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308101724018.png",alt:""}})])]),t("p",[e._v("像这样，"),t("strong",[e._v("将一个集群中正在运行的多个Pod版本，交替地逐一升级的过程，就是“滚动更新”")]),e._v("。")]),e._v(" "),t("h2",{attrs:{id:"_2-deployment的更新"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-deployment的更新"}},[e._v("#")]),e._v(" 2. Deployment的更新")]),e._v(" "),t("p",[e._v("可以使用 "),t("code",[e._v("edit")]),e._v(" 命令直接编辑Deployment进行更新：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl edit deployments.apps/nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("使用 "),t("code",[e._v("rollout status")]),e._v(" 查看更新过程：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout status deployments.apps/nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("当进行Deployment新建或者更新后，Deployment都会把 "),t("code",[e._v("pod-template-hash")]),e._v(" 标签添加到 每个由Deployment控制的ReplicaSet上，确保每个ReplicaSet的唯一性。"),t("strong",[e._v("不要更改此标签")])]),e._v(" "),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308101724018.png",alt:""}})])]),t("h2",{attrs:{id:"_3-deployment的回滚"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-deployment的回滚"}},[e._v("#")]),e._v(" 3. Deployment的回滚")]),e._v(" "),t("blockquote",[t("p",[e._v("当更新了版本不稳定或配置不合理时，可以对其进行回滚操作。"),t("strong",[e._v("默认情况下，Deployment 的所有上线记录都保留在系统中")]),e._v("，以便可以随时回滚。")])]),e._v(" "),t("h3",{attrs:{id:"_3-1-查看历史版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-查看历史版本"}},[e._v("#")]),e._v(" 3.1. 查看历史版本")]),e._v(" "),t("p",[e._v("使用 "),t("code",[e._v("rollout history")]),e._v(" 查看更新历史：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("history")]),e._v(" deployment/nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("div",{staticClass:"center-container"},[t("p",[t("img",{attrs:{src:"https://static.xiaoliutalk.cn/img/202308161531589.png",alt:""}})])]),t("p",[e._v("其中，"),t("code",[e._v("CHANGE-CAUSE")]),e._v(" 的内容是从 Deployment 的 "),t("code",[e._v("kubernetes.io/change-cause")]),e._v(" 注解复制过来的，可以通过以下方式设置：")]),e._v(" "),t("ul",[t("li",[e._v("使用 "),t("code",[e._v('kubectl annotate deployment/nginx-deployment kubernetes.io/change-cause="image updated to latest"')]),e._v(" 为 Deployment 添加注解。")]),e._v(" "),t("li",[e._v("手动编辑Deployment文件进行更新。")])]),e._v(" "),t("p",[e._v("查看更新历史的详细信息：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("history")]),e._v(" deployment/nginx-deployment "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--revision")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-2-回滚历史版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-回滚历史版本"}},[e._v("#")]),e._v(" 3.2. 回滚历史版本")]),e._v(" "),t("p",[e._v("使用 "),t("code",[e._v("rollout undo")]),e._v(" 从 "),t("code",[e._v("revision 2")]),e._v(" 回滚到 "),t("code",[e._v("revision 1")]),e._v(" ：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout undo deployment/nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("也可以手动指定 "),t("code",[e._v("revision")]),e._v(" ：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout undo deployment/nginx-deployment --to-revision"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h3",{attrs:{id:"_3-3-修改历史版本数量限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-修改历史版本数量限制"}},[e._v("#")]),e._v(" 3.3. 修改历史版本数量限制")]),e._v(" "),t("p",[e._v("默认情况下，"),t("code",[e._v("revision")]),e._v(" 保留10个旧的ReplicaSet，其余的将在后台进行垃圾回收，可以在 "),t("code",[e._v(".spec.revisionHistoryLimit")]),e._v(" 设置保留 ReplicaSet 的个数。当设置为0时，不保留历史记录，也就意味着无法进行历史版本回滚了。")]),e._v(" "),t("h2",{attrs:{id:"_4-deployment的扩缩容-暂停和恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-deployment的扩缩容-暂停和恢复"}},[e._v("#")]),e._v(" 4. Deployment的扩缩容&暂停和恢复")]),e._v(" "),t("h3",{attrs:{id:"_4-1-deployment的扩缩容"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-deployment的扩缩容"}},[e._v("#")]),e._v(" 4.1. Deployment的扩缩容")]),e._v(" "),t("p",[e._v("使用 "),t("code",[e._v("scale")]),e._v(" 进行Deployment的扩容，副本数为5：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl scale deployment/nginx-deployment "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[e._v("--replicas")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("5")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h3",{attrs:{id:"_4-2-deployment的暂停和恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-deployment的暂停和恢复"}},[e._v("#")]),e._v(" 4.2. Deployment的暂停和恢复")]),e._v(" "),t("p",[e._v("每次我们使用 "),t("code",[e._v("edit")]),e._v(" 或者 "),t("code",[e._v("set image")]),e._v(" 指令等等进行Deployment更新时，都会生成一个新的ReplicaSet对象，而通过"),t("strong",[e._v("暂停")]),e._v("可以使我们对"),t("strong",[e._v("Deployment的多次更新操作的最终结果只生成一个ReplicaSet")]),e._v("：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout pause deployment/nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("暂停后可以任意修改，最后恢复Deployment：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl rollout resume deployment/nginx-deployment\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("发现只有一个新的ReplicaSet生成，也就是"),t("strong",[e._v("通过暂停和恢复Deployment，只触发了一次“滚动更新”")]),e._v("。")]),e._v(" "),t("h2",{attrs:{id:"_5-控制滚动更新速率"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-控制滚动更新速率"}},[e._v("#")]),e._v(" 5. 控制滚动更新速率")]),e._v(" "),t("p",[e._v("在Deployment的滚动升级期间，有两个属性会决定一次替换多少个pod。可以通过Deployment的 "),t("code",[e._v("strategy")]),e._v(" 字段下 "),t("code",[e._v("rollingUpdate")]),e._v(" 的子属性来配置：")]),e._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("strategy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("rollingUpdate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("maxSurge")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 25%\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("maxUnavailable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" 25%\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" RollingUpdate\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br")])]),t("table",[t("thead",[t("tr",[t("th",[e._v("种类")]),e._v(" "),t("th",[e._v("说明")])])]),e._v(" "),t("tbody",[t("tr",[t("td",[e._v("maxSurge")]),e._v(" "),t("td",[e._v("决定了Deployment在"),t("strong",[e._v("滚动更新的过程中最多允许超出的Pod实例的数量")]),e._v("。默认值为25%，所以Pod实例最多可以比replicas数量多25%。如果replicas被设置为4，那么在滚动升级期间，不会运行超过5个Pod。值也可以设置为数字。")])]),e._v(" "),t("tr",[t("td",[e._v("maxUnavailable")]),e._v(" "),t("td",[e._v("决定了Deployment在"),t("strong",[e._v("滚动更新的过程中最多允许有多少Pod处于不可用状态")]),e._v("。默认值也是25%，所以可用 pod 实例的数量不能低于期望副本数的75%，百分数转换成绝对值时这个数字会四舍五入。如果replicas被设置为4，那么在滚动升级期间，只能有一个 pod 处于不可用状态。值也可以设置为数字。")])])])]),e._v(" "),t("h2",{attrs:{id:"_6-阻止错误版本的滚动更新"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-阻止错误版本的滚动更新"}},[e._v("#")]),e._v(" 6. 阻止错误版本的滚动更新")]),e._v(" "),t("p",[t("code",[e._v(".spec.minReadySeconds")]),e._v(" 属性指定新创建的pod至少要成功运行多久之后，才能将其视为可用Pod（"),t("strong",[e._v("在容器的健康检查通过之后开始计算")]),e._v("），默认值为0。")]),e._v(" "),t("p",[t("code",[e._v("minReadySeconds")]),e._v(" 的主要功能是避免部署出错版本的应用，如果一个新的pod运行出错，并且在 "),t("code",[e._v("minReadySeconds")]),e._v(" 时间内它的就绪探针出现了失败，那么新版本的滚动更新将被阻止。")]),e._v(" "),t("p",[e._v("参考文章及书籍：")]),e._v(" "),t("ul",[t("li",[t("p",[t("a",{attrs:{href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Deployments"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"http://product.dangdang.com/26439199.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Kubernetes in Action"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"http://product.dangdang.com/29222386.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("深入剖析Kubernetes"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[t("a",{attrs:{href:"http://product.dangdang.com/29404674.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("云原生Kubernetes全栈架构师实战"),t("OutboundLink")],1)])])])])}),[],!1,null,null,null);t.default=n.exports}}]);